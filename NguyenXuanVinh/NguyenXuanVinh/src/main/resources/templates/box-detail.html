<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${box.boxName}">Chi tiáº¿t há»™p</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<header>
    <div class="logo"><a href="/" style="text-decoration:none; color:#ff4757;"><i class="fas fa-gift"></i> Mystery Box</a></div>
    <div class="menu">
        <a href="/" class="nav-link">ğŸ  Trang Chá»§</a>
        <a href="/cart" class="nav-link">ğŸ›’ Giá» HÃ ng</a>
        <a href="/inventory" class="nav-link">ğŸ’ Kho Äá»“</a>
    </div>
    <div class="user-info" th:if="${user != null}">
        <div class="wallet">ğŸ’° <span th:text="${#numbers.formatDecimal(user.walletBalance, 0, 'COMMA', 0, 'POINT')}">0</span> Ä‘</div>
    </div>
</header>

<div class="container" style="margin-top: 50px;">

    <div class="detail-container">
        <div class="detail-image">
            <img th:src="${box.imageUrl}" alt="Box Image">
        </div>
        <div class="detail-info">
            <h1 th:text="${box.boxName}">TÃªn Há»™p</h1>
            <div class="price-tag large" th:text="${#numbers.formatDecimal(box.price, 0, 'COMMA', 0, 'POINT')} + ' Ä‘'">100.000 Ä‘</div>
            <p class="desc" th:text="${box.description}">MÃ´ táº£...</p>

            <div class="action-buttons vertical">
                <button class="btn-buy big-btn" th:onclick="'openBox(' + ${box.boxId} + ')'">ğŸ”¥ Má» NGAY (1 Láº¦N)</button>
                <button class="btn-cart big-btn" th:onclick="'addToCart(' + ${box.boxId} + ')'">ğŸ›’ THÃŠM VÃ€O GIá»</button>
            </div>
        </div>
    </div>

    <h2 class="section-title" style="margin-top: 80px;">âœ¨ CÃ“ GÃŒ BÃŠN TRONG? âœ¨</h2>
    <div class="showcase-grid">
        <div class="showcase-item" th:each="item : ${items}">
            <div class="rarity-badge" th:text="${item.rarityLevel}"
                 th:classappend="'rank-' + ${item.rarityLevel}">S</div>

            <img th:src="${item.imageUrl}" alt="Item">
            <p class="item-name" th:text="${item.itemName}">TÃªn mÃ³n</p>
            <p class="drop-rate"
   th:text="'Tá»‰ lá»‡: ' + ${#numbers.formatDecimal(item.probability * 100, 1, 2)} + '%'">
   3.33%
</p>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:inline="javascript">
    // Báº¡n copy nguyÃªn si 3 hÃ m: openBox, addToCart, showResult tá»« index.html dÃ¡n vÃ o Ä‘Ã¢y nhÃ©!
    // (Hoáº·c náº¿u lÆ°á»i thÃ¬ báº£o mÃ¬nh gá»­i láº¡i full script cho)

    // --- CHá»– NÃ€Y DÃN SCRIPT VÃ€O ---
    function promptLogin() { Swal.fire('Lá»—i', 'Vui lÃ²ng Ä‘Äƒng nháº­p!', 'warning').then(()=>window.location.href='/login'); }

    function openBox(boxId) {
        const userId = [[${user != null ? user.userId : 'null'}]];
        if(userId=='null') { promptLogin(); return; }
        Swal.fire({title:'Äang má»Ÿ...', didOpen:()=>{Swal.showLoading()}});
        fetch(`/api/blindbox/open?userId=${userId}&boxId=${boxId}`, {method:'POST'})
        .then(res=>res.json()).then(data=>showResult(data)).catch(()=>Swal.fire('Lá»—i','Tiá»n khÃ´ng Ä‘á»§','error'));
    }

    function addToCart(boxId) {
        const userId = [[${user != null ? user.userId : 'null'}]];
        if(userId=='null') { promptLogin(); return; }
        fetch(`/api/cart/add?userId=${userId}&boxId=${boxId}`, {method:'POST'}).then(res=>{
            if(res.ok) Swal.fire({toast:true, position:'top-end', icon:'success', title:'ÄÃ£ thÃªm vÃ o giá»!', showConfirmButton:false, timer:1500});
        });
    }

    function showResult(data) {
        let color = data.rarity == 'S' ? '#ffd700' : (data.rarity == 'A' ? '#c92a2a' : '#fff');
        Swal.fire({
            title: `<span style="color:${color}">Báº N TRÃšNG: ${data.rarity}</span>`,
            html: `<img src="${data.itemImage}" style="width:150px"><br><h3>${data.itemName}</h3>`,
            confirmButtonText: 'OK'
        }).then(()=>location.reload());
    }
</script>

</body>
</html>