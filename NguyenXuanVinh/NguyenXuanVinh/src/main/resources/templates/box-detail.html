<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${box.boxName} + ' | Mystery Box'">Chi Ti·∫øt H·ªôp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<header>
    <div class="logo">
        <a href="/" style="text-decoration:none; color:#66fcf1;"><i class="fas fa-gift"></i> Mystery Box</a>
    </div>

    <div class="menu">
        <a href="/" class="nav-link">üè† Trang Ch·ªß</a>
        <a href="/cart" class="nav-link">üõçÔ∏è Gi·ªè H√†ng</a>
        <a href="/inventory" class="nav-link">üéí Kho ƒê·ªì</a>
        <a href="/deposit" class="nav-link deposit-btn">üíé N·∫°p Xu</a>
        <a href="/admin" class="nav-link admin-btn" th:if="${nxvUser != null and nxvUser.isAdmin}">üõ†Ô∏è Qu·∫£n Tr·ªã</a>
    </div>

    <div class="user-info d-flex align-items-center" th:if="${nxvUser != null}">
        <div class="wallet-badge me-3" title="S·ªë D∆∞ Hi·ªán T·∫°i">
            <i class="fas fa-coins wallet-icon"></i>
            <span id="wallet-balance" class="wallet-amount" th:text="${#numbers.formatDecimal(nxvUser.walletBalance, 0, 'COMMA', 0, 'POINT')}">0</span>
            <small class="currency">ƒë</small>
        </div>

        <div class="user-dropdown-container">
            <div class="user-trigger">
                <span class="username d-none d-lg-inline me-2" th:text="${nxvUser.username}">User</span>
                <img th:src="'https://ui-avatars.com/api/?background=random&color=fff&name=' + ${nxvUser.fullName}" class="user-avatar-glow">
            </div>

            <div class="dropdown-menu-custom">
                <div class="dropdown-header-info">
                    Xin ch√†o, <b th:text="${nxvUser.fullName}" style="color: #fff;">Name</b>
                </div>
                <a href="/profile" class="dropdown-item-custom"><i class="fas fa-id-card"></i> H·ªì S∆° C√° Nh√¢n</a>
                <a href="/inventory" class="dropdown-item-custom"><i class="fas fa-box-open"></i> Kho ƒê·ªì</a>
                <a href="/shipment/history" class="dropdown-item-custom"><i class="fas fa-history"></i> L·ªãch S·ª≠ Giao D·ªãch</a>
                <a href="/logout" class="dropdown-item-custom logout"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</a>
            </div>
        </div>
    </div>

    <div class="user-info" th:if="${nxvUser == null}">
        <a href="/login" class="btn-buy" style="padding: 8px 25px; text-decoration: none; display: inline-block;">ƒêƒÉng Nh·∫≠p</a>
    </div>
</header>

<div class="container" style="margin-top: 50px;">

    <div class="detail-container">
        <div class="detail-image">
            <img th:src="${box.imageUrl}" alt="Box Image" class="img-fluid">
        </div>

        <div class="detail-info">
            <h1 th:text="${box.boxName}" style="text-shadow: 0 0 10px var(--neon-cyan);">T√™n H·ªôp</h1>

            <div class="price-tag large" style="font-size: 2.5rem; color: #ffd700; font-weight: 800;">
                <span th:text="${#numbers.formatDecimal(box.price, 0, 'COMMA', 0, 'POINT')}">100.000</span> ƒë
            </div>

            <p class="desc text-muted mb-4" th:text="${box.description}" style="font-size: 1.1rem; line-height: 1.6;">M√¥ T·∫£ Chi Ti·∫øt...</p>

            <div class="action-buttons vertical">
                <button class="btn-buy big-btn" th:onclick="'openBox(' + ${box.boxId} + ')'" style="width: 100%; padding: 15px; font-size: 1.2rem;">
                    <i class="fas fa-magic me-2"></i> M·ªû NGAY (1 L·∫¶N)
                </button>
                <button class="btn-cart big-btn mt-3" th:onclick="'addToCart(' + ${box.boxId} + ')'" style="width: 100%; padding: 15px; font-size: 1.2rem;">
                    <i class="fas fa-cart-plus me-2"></i> TH√äM V√ÄO GI·ªé
                </button>
            </div>
        </div>
    </div>

    <h2 class="section-title" style="margin-top: 80px; color: var(--neon-cyan);">‚ú® C√ì G√å B√äN TRONG? ‚ú®</h2>

    <div class="showcase-grid">
        <div class="showcase-item" th:each="item : ${items}">
            <div class="rarity-badge" th:text="${item.rarityLevel}"
                 th:classappend="'rank-' + ${item.rarityLevel}">S</div>

            <div class="img-wrapper">
                <img th:src="${item.imageUrl}" alt="Item">
            </div>

            <div class="item-info">
                <p class="item-name" th:text="${item.itemName}">T√™n V·∫≠t Ph·∫©m</p>
                <div class="drop-rate-box">
                    <span class="drop-rate" style="color: #aaa; font-size: 13px;">
                        <i class="fas fa-dice"></i> T·ª∑ l·ªá:
                        <span style="color: #fff; font-weight: bold;" th:text="${#numbers.formatDecimal(item.probability * 100, 1, 2)} + '%'">1.5%</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${items.isEmpty()}" class="text-center text-muted col-12 py-5">
        <p>Ch∆∞a C√≥ Th√¥ng Tin V·∫≠t Ph·∫©m Cho H·ªôp N√†y.</p>
    </div>

</div>

<footer class="mt-5 text-center p-4 border-top border-secondary text-muted">
    &copy; 2025 Mystery Box Shop. Design by Nguyen Xuan Vinh.
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script th:inline="javascript">
    const userId = [[${nxvUser != null ? nxvUser.userId : 'null'}]];

    function promptLogin() {
        Swal.fire({
            title: 'Ch∆∞a ƒêƒÉng Nh·∫≠p!',
            text: 'Vui L√≤ng ƒêƒÉng Nh·∫≠p ƒê·ªÉ Ti·∫øp T·ª•c.',
            icon: 'warning',
            confirmButtonText: 'ƒêƒÉng Nh·∫≠p Ngay',
            background: '#111', color: '#fff',
            confirmButtonColor: '#66fcf1'
        }).then((res) => {
            if(res.isConfirmed) window.location.href='/login';
        });
    }

    function openBox(boxId) {
        if (userId === 'null') { promptLogin(); return; }

        Swal.fire({
            title: 'ƒêang M·ªü H·ªôp...',
            html: 'Ch·ªù X√≠u Nh√©, ƒêang C·∫ßu Nguy·ªán Nh√¢n Ph·∫©m! üôè',
            timerProgressBar: true,
            background: '#111', color: '#fff',
            didOpen: () => { Swal.showLoading() }
        });

        fetch(`/api/blindbox/open?userId=${userId}&boxId=${boxId}`, { method: 'POST' })
        .then(res => {
            if (!res.ok) throw new Error("L·ªói");
            return res.json();
        })
        .then(data => showResult(data, boxId))
        .catch(() => Swal.fire({
            icon: 'error', title: 'Th·∫•t B·∫°i',
            text: 'S·ªë D∆∞ Kh√¥ng ƒê·ªß Ho·∫∑c L·ªói H·ªá Th·ªëng.',
            background: '#111', color: '#fff',
            confirmButtonColor: '#ff4757'
        }));
    }

    function addToCart(boxId) {
        if (userId === 'null') { promptLogin(); return; }

        fetch(`/api/cart/add?userId=${userId}&boxId=${boxId}`, { method: 'POST' })
        .then(res => {
            if(res.ok) {
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 2000,
                    background: '#111', color: '#fff'
                })
                Toast.fire({ icon: 'success', title: 'ƒê√£ Th√™m V√†o Gi·ªè!' })
            } else {
                Swal.fire({icon: 'error', title: 'L·ªói', text: 'Kh√¥ng Th·ªÉ Th√™m V√†o Gi·ªè', background: '#111', color: '#fff'});
            }
        });
    }

    function showResult(data, currentBoxId) {
        // 1. M√†u s·∫Øc cho Title v√† Hi·ªáu ·ª©ng (Glow) d·ª±a tr√™n Rank
        let titleColor = '#fff'; // M·∫∑c ƒë·ªãnh cho C, D
        if(data.rarity === 'S') titleColor = '#ffd700';
        else if(data.rarity === 'A') titleColor = '#ff4757';
        else if(data.rarity === 'B') titleColor = '#9b59b6';

        // 2. C·∫≠p nh·∫≠t ti·ªÅn tr√™n header
        if(data.currentBalance) {
            document.getElementById('wallet-balance').innerText = new Intl.NumberFormat('en-US').format(data.currentBalance);
        }

        // 3. T·∫°o n·ªôi dung Pity (B·∫£o hi·ªÉm)
        let pityText = "";
        if (data.rarity !== 'S') {
            pityText = `<div style="margin-top: 15px; font-size: 13px; color: #aaa; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px;">
                            <i class="fas fa-shield-alt"></i> B·∫£o hi·ªÉm S: c√≤n <b style="color: #66fcf1;">${data.spinsUntilPity}</b> l·∫ßn
                        </div>`;
        } else {
            pityText = `<div style="margin-top: 15px; color: #ffd700; font-weight: bold; font-size: 14px;">
                            üéâ ƒê√É N·ªî H≈® B·∫¢O HI·ªÇM!
                        </div>`;
        }

        // 4. Hi·ªÉn th·ªã Popup
        Swal.fire({
            title: `<span style="color:${titleColor}; text-shadow: 0 0 10px ${titleColor}">üéâ B·∫†N TR√öNG: ${data.rarity} üéâ</span>`,
            html: `
                <div style="text-align:center">
                    <img src="${data.itemImage}" style="width:120px; height:120px; display: block; object-fit: contain; margin: 15px auto; border-radius:15px; box-shadow:0 0 20px ${titleColor}; border: 2px solid ${titleColor}; background: #222;">

                    <h3 style="color: #fff; margin-top: 15px; text-transform: uppercase; font-size: 1.2rem;">${data.itemName}</h3>
                    <p style="color: #ccc; font-size: 14px; margin-bottom: 5px;">S·ªë d∆∞ m·ªõi: <b style="color: #66fcf1;">${new Intl.NumberFormat('en-US').format(data.currentBalance)} ƒë</b></p>
                    ${pityText}
                    <a href="/inventory" class="btn btn-sm btn-outline-light mt-3" style="border-color: #555; color: #aaa;">Xem Kho ƒê·ªì</a>
                </div>
            `,
            confirmButtonText: 'M·ªü Ti·∫øp! üé≤',
            // ƒê·ªíNG B·ªò M√ÄU N√öT: Lu√¥n d√πng m√†u xanh Neon ch·ªß ƒë·∫°o ƒë·ªÉ d·ªÖ ƒë·ªçc
            confirmButtonColor: '#66fcf1',
            showCancelButton: true,
            cancelButtonText: 'ƒê√≥ng',
            cancelButtonColor: '#333',
            background: 'rgba(15, 20, 25, 0.98)', color: '#fff',
            backdrop: `rgba(0,0,0,0.8)`
        }).then((res) => {
            if(res.isConfirmed) openBox(currentBoxId);
        });
    }
</script>

</body>
</html>