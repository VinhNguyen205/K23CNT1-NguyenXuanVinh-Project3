<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${box.boxName}">Chi tiáº¿t há»™p</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<header>
    <div class="logo">
        <a href="/" style="text-decoration:none; color:#66fcf1;"><i class="fas fa-gift"></i> Mystery Box</a>
    </div>

    <div class="menu">
        <a href="/" class="nav-link">ğŸ  Trang Chá»§</a>
        <a href="/cart" class="nav-link">ğŸ›’ Giá» HÃ ng</a>
        <a href="/inventory" class="nav-link">ğŸ’ Kho Äá»“</a>
        <a href="/deposit" class="nav-link deposit-btn">ğŸ’ Náº¡p Xu</a>

        <a href="/admin" class="nav-link admin-btn" th:if="${nxvUser != null and nxvUser.isAdmin}">ğŸ› ï¸ Quáº£n Trá»‹</a>
    </div>

    <div class="user-info" th:if="${nxvUser != null}">
        <div class="user-details">
            <a href="/profile" style="color: #fff; text-decoration: none; font-weight: 600;">
                Xin chÃ o, <span th:text="${nxvUser.fullName}" style="color: #66fcf1;">User</span>
            </a>
            <br>
            <a href="/logout" class="logout-link">ğŸšª ÄÄƒng xuáº¥t</a>
        </div>
        <div class="wallet">
            ğŸ’° <span th:text="${#numbers.formatDecimal(nxvUser.walletBalance, 0, 'COMMA', 0, 'POINT')}">0</span> VNÄ
        </div>
    </div>

    <div class="user-info" th:if="${nxvUser == null}">
        <a href="/login" class="btn-buy" style="padding: 8px 20px; text-decoration: none; width: auto; margin: 0;">ÄÄƒng Nháº­p</a>
    </div>
</header>

<div class="container" style="margin-top: 50px;">

    <div class="detail-container">
        <div class="detail-image">
            <img th:src="${box.imageUrl}" alt="Box Image">
        </div>
        <div class="detail-info">
            <h1 th:text="${box.boxName}">TÃªn Há»™p</h1>
            <div class="price-tag large" th:text="${#numbers.formatDecimal(box.price, 0, 'COMMA', 0, 'POINT')} + ' Ä‘'">100.000 Ä‘</div>
            <p class="desc" th:text="${box.description}">MÃ´ táº£...</p>

            <div class="action-buttons vertical">
                <button class="btn-buy big-btn" th:onclick="'openBox(' + ${box.boxId} + ')'"><i class="fas fa-magic"></i> Má» NGAY (1 Láº¦N)</button>
                <button class="btn-cart big-btn" th:onclick="'addToCart(' + ${box.boxId} + ')'"><i class="fas fa-cart-plus"></i> THÃŠM VÃ€O GIá»</button>
            </div>
        </div>
    </div>

    <h2 class="section-title" style="margin-top: 80px;">âœ¨ CÃ“ GÃŒ BÃŠN TRONG? âœ¨</h2>
    <div class="showcase-grid">
        <div class="showcase-item" th:each="item : ${items}">
            <div class="rarity-badge" th:text="${item.rarityLevel}"
                 th:classappend="'rank-' + ${item.rarityLevel}">S</div>

            <img th:src="${item.imageUrl}" alt="Item">
            <p class="item-name" th:text="${item.itemName}">TÃªn mÃ³n</p>
            <p class="drop-rate"
               th:text="'Tá»‰ lá»‡: ' + ${#numbers.formatDecimal(item.probability * 100, 1, 2)} + '%'">1%</p>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:inline="javascript">
    function promptLogin() {
        Swal.fire({
            title: 'ChÆ°a Ä‘Äƒng nháº­p!',
            text: 'Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ tiáº¿p tá»¥c.',
            icon: 'warning',
            confirmButtonText: 'ÄÄƒng nháº­p ngay'
        }).then((res) => {
            if(res.isConfirmed) window.location.href='/login';
        });
    }

    function openBox(boxId) {
        const userId = [[${nxvUser != null ? nxvUser.userId : 'null'}]];
        if (userId === 'null' || userId === null) { promptLogin(); return; }

        Swal.fire({
            title: 'Äang má»Ÿ há»™p...',
            html: 'Chá» xÃ­u nhÃ©, Ä‘ang cáº§u nguyá»‡n nhÃ¢n pháº©m! ğŸ™',
            timerProgressBar: true,
            didOpen: () => { Swal.showLoading() }
        });

        // ÄÃ£ sá»­a lá»—i: dÃ¹ng biáº¿n userId (thay vÃ¬ nxvUserId)
        fetch(`/api/blindbox/open?userId=${userId}&boxId=${boxId}`, { method: 'POST' })
        .then(res => {
            if (!res.ok) throw new Error("Tiá»n khÃ´ng Ä‘á»§ hoáº·c lá»—i máº¡ng");
            return res.json();
        })
        .then(data => showResult(data))
        .catch(() => Swal.fire('Lá»—i!', 'Báº¡n khÃ´ng Ä‘á»§ tiá»n hoáº·c cÃ³ lá»—i xáº£y ra.', 'error'));
    }

    function addToCart(boxId) {
        const userId = [[${nxvUser != null ? nxvUser.userId : 'null'}]];
        if (userId === 'null' || userId === null) { promptLogin(); return; }

        // ÄÃ£ sá»­a lá»—i: dÃ¹ng biáº¿n userId (thay vÃ¬ nxvUserId)
        // LÆ°u Ã½: API giá» hÃ ng endpoint lÃ  /api/cart/add (chá»© khÃ´ng pháº£i nxvCart)
        fetch(`/api/cart/add?userId=${userId}&boxId=${boxId}`, { method: 'POST' })
        .then(res => {
            if(res.ok) {
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 2000,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer);
                        toast.addEventListener('mouseleave', Swal.resumeTimer);
                    }
                })
                Toast.fire({ icon: 'success', title: 'ÄÃ£ thÃªm vÃ o giá»!' })
            } else {
                Swal.fire('Lá»—i', 'KhÃ´ng thá»ƒ thÃªm vÃ o giá»', 'error');
            }
        });
    }

    function showResult(data) {
        let titleColor = '#000';
        if(data.rarity === 'S') titleColor = '#ffd700';
        else if(data.rarity === 'A') titleColor = '#ff4757';
        else if(data.rarity === 'B') titleColor = '#9b59b6';
        else if(data.rarity === 'C') titleColor = '#3498db';

        Swal.fire({
            title: `<span style="color:${titleColor}">ğŸ‰ Báº N TRÃšNG: ${data.rarity} ğŸ‰</span>`,
            html: `
                <div style="text-align:center">
                    <img src="${data.itemImage}" style="width:150px; margin:10px auto; border-radius:10px; box-shadow:0 0 15px ${titleColor}">
                    <h3>${data.itemName}</h3>
                    <p>Sá»‘ dÆ° cÃ²n láº¡i: <b>${new Intl.NumberFormat().format(data.currentBalance)} Ä‘</b></p>
                </div>
            `,
            confirmButtonText: 'Tuyá»‡t vá»i!',
            background: '#fff url(/images/confetti.gif)'
        }).then(() => location.reload());
    }
</script>

</body>
</html>