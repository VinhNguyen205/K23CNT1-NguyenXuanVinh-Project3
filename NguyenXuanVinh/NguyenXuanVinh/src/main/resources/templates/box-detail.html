<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${box.boxName} + ' | Mystery Box'">Chi Ti·∫øt H·ªôp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css?v=2">
</head>
<body>

<header>
    <div class="logo">
        <a href="/" style="text-decoration:none; color:#66fcf1;"><i class="fas fa-gift"></i> Mystery Box</a>
    </div>

    <div class="menu">
        <a href="/" class="nav-link">üè† Trang Ch·ªß</a>
        <a href="/cart" class="nav-link">üõçÔ∏è Gi·ªè H√†ng</a>
        <a href="/deposit" class="nav-link deposit-btn">üíé N·∫°p Xu</a>
        <a href="/admin" class="nav-link" style="border: 1px solid #ff4757; color: #ff4757;" th:if="${nxvUser != null and nxvUser.isAdmin}">üõ†Ô∏è Qu·∫£n Tr·ªã</a>
    </div>

    <div class="user-info" th:if="${nxvUser != null}">
        <div class="wallet me-3" style="font-size: 14px;">
            üí∞ <span th:text="${#numbers.formatDecimal(nxvUser.walletBalance, 0, 'COMMA', 0, 'POINT')}">0</span>
        </div>
        <div class="user-dropdown">
            <div class="text-end me-2 d-none d-md-block">
                <div style="font-size: 12px; color: #888;">Xin Ch√†o,</div>
                <div style="font-weight: bold; color: var(--neon-cyan);" th:text="${nxvUser.username}">User</div>
            </div>
            <img th:src="'https://ui-avatars.com/api/?background=random&color=fff&name=' + ${nxvUser.fullName}" class="user-avatar" alt="Avatar">

            <div class="dropdown-menu-custom">
                <div style="padding: 15px; border-bottom: 1px solid #333; text-align: center;">
                    <span style="color: var(--neon-pink); font-weight: bold;">TH√ÄNH VI√äN VIP</span>
                </div>
                <a href="/profile" class="dropdown-item-custom"><i class="fas fa-id-card"></i> H·ªì S∆°</a>
                <a href="/inventory" class="dropdown-item-custom"><i class="fas fa-box-open"></i> Kho ƒê·ªì</a>
                <a href="/cart" class="dropdown-item-custom"><i class="fas fa-shopping-cart"></i> Gi·ªè H√†ng</a>
                <a href="/logout" class="dropdown-item-custom" style="color: var(--neon-pink);"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</a>
            </div>
        </div>
    </div>

    <div class="user-info" th:if="${nxvUser == null}">
        <a href="/login" class="btn-buy" style="padding: 8px 20px; text-decoration: none; width: auto; margin: 0;">
            <i class="fas fa-user"></i> ƒêƒÉng Nh·∫≠p
        </a>
    </div>
</header>

<div class="container" style="margin-top: 50px;">

    <div class="detail-container">
        <div class="detail-image">
            <img th:src="${box.imageUrl}" alt="Box Image" class="img-fluid">
        </div>

        <div class="detail-info">
            <h1 th:text="${box.boxName}" style="text-shadow: 0 0 10px var(--neon-cyan);">T√™n H·ªôp</h1>

            <div class="price-tag large" style="font-size: 2.5rem; color: var(--neon-yellow);">
                <span th:text="${#numbers.formatDecimal(box.price, 0, 'COMMA', 0, 'POINT')}">100.000</span> ƒë
            </div>

            <p class="desc text-muted mb-4" th:text="${box.description}">M√¥ T·∫£ Chi Ti·∫øt...</p>

            <div class="action-buttons vertical">
                <button class="btn-buy big-btn" th:onclick="'openBox(' + ${box.boxId} + ')'">
                    <i class="fas fa-magic me-2"></i> M·ªû NGAY (1 L·∫¶N)
                </button>
                <button class="btn-cart big-btn" th:onclick="'addToCart(' + ${box.boxId} + ')'">
                    <i class="fas fa-cart-plus me-2"></i> TH√äM V√ÄO GI·ªé
                </button>
            </div>
        </div>
    </div>

    <h2 class="section-title" style="margin-top: 80px;">‚ú® C√ì G√å B√äN TRONG? ‚ú®</h2>

    <div class="showcase-grid">
        <div class="showcase-item" th:each="item : ${items}">
            <div class="rarity-badge" th:text="${item.rarityLevel}"
                 th:classappend="'rank-' + ${item.rarityLevel}">S</div>

            <div class="img-wrapper">
                <img th:src="${item.imageUrl}" alt="Item">
            </div>

            <div class="item-info">
                <p class="item-name" th:text="${item.itemName}">T√™n V·∫≠t Ph·∫©m</p>
                <div class="drop-rate-box">
                    <span class="drop-rate">
                        <i class="fas fa-dice"></i>
                        <span th:text="${#numbers.formatDecimal(item.probability * 100, 1, 2)} + '%'">1.5%</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

        <div th:if="${items.isEmpty()}" class="text-center text-muted col-12">
            <p>Ch∆∞a C√≥ Th√¥ng Tin V·∫≠t Ph·∫©m Cho H·ªôp N√†y.</p>
        </div>
    </div>

</div>

<footer class="mt-5 text-center p-4 border-top border-secondary text-muted">
    &copy; 2025 Mystery Box Shop. Design by Nguyen Xuan Vinh.
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script th:inline="javascript">
    // L·∫•y ID User an to√†n
    const userId = [[${nxvUser != null ? nxvUser.userId : 'null'}]];

    function promptLogin() {
        Swal.fire({
            title: 'Ch∆∞a ƒêƒÉng Nh·∫≠p!',
            text: 'Vui L√≤ng ƒêƒÉng Nh·∫≠p ƒê·ªÉ Ti·∫øp T·ª•c.',
            icon: 'warning',
            confirmButtonText: 'ƒêƒÉng Nh·∫≠p Ngay',
            background: '#111', color: '#fff' // Dark theme
        }).then((res) => {
            if(res.isConfirmed) window.location.href='/login';
        });
    }

    function openBox(boxId) {
        if (userId === 'null') { promptLogin(); return; }

        Swal.fire({
            title: 'ƒêang M·ªü H·ªôp...',
            html: 'Ch·ªù X√≠u Nh√©, ƒêang C·∫ßu Nguy·ªán Nh√¢n Ph·∫©m! üôè',
            timerProgressBar: true,
            background: '#111', color: '#fff',
            didOpen: () => { Swal.showLoading() }
        });

        fetch(`/api/blindbox/open?userId=${userId}&boxId=${boxId}`, { method: 'POST' })
        .then(res => {
            if (!res.ok) throw new Error("L·ªói");
            return res.json();
        })
        .then(data => showResult(data))
        .catch(() => Swal.fire({
            icon: 'error', title: 'Th·∫•t B·∫°i',
            text: 'S·ªë D∆∞ Kh√¥ng ƒê·ªß Ho·∫∑c L·ªói H·ªá Th·ªëng.',
            background: '#111', color: '#fff'
        }));
    }

    function addToCart(boxId) {
        if (userId === 'null') { promptLogin(); return; }

        fetch(`/api/cart/add?userId=${userId}&boxId=${boxId}`, { method: 'POST' })
        .then(res => {
            if(res.ok) {
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 2000,
                    background: '#111', color: '#fff',
                    didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }
                })
                Toast.fire({ icon: 'success', title: 'ƒê√£ Th√™m V√†o Gi·ªè!' })
            } else {
                Swal.fire({icon: 'error', title: 'L·ªói', text: 'Kh√¥ng Th·ªÉ Th√™m V√†o Gi·ªè', background: '#111', color: '#fff'});
            }
        });
    }

    function showResult(data) {
        let titleColor = '#fff';
        if(data.rarity === 'S') titleColor = '#ffd700';
        else if(data.rarity === 'A') titleColor = '#ff4757';

        Swal.fire({
            title: `<span style="color:${titleColor}">üéâ B·∫†N TR√öNG: ${data.rarity} üéâ</span>`,
            html: `
                <div style="text-align:center">
                    <img src="${data.itemImage}" style="width:150px; margin:10px auto; border-radius:10px; box-shadow:0 0 20px ${titleColor}; border: 2px solid ${titleColor}">
                    <h3 style="color: #fff; margin-top: 10px;">${data.itemName}</h3>
                    <p style="color: #ccc;">S·ªë d∆∞ m·ªõi: <b style="color: #66fcf1;">${new Intl.NumberFormat().format(data.currentBalance)} ƒë</b></p>
                    <a href="/inventory" class="btn btn-sm btn-outline-info mt-2">Xem Kho ƒê·ªì</a>
                </div>
            `,
            confirmButtonText: 'M·ªü Ti·∫øp!',
            showCancelButton: true,
            cancelButtonText: 'ƒê√≥ng',
            background: '#1f2833', color: '#fff'
        }).then((res) => {
            if(res.isConfirmed) openBox(data.inventoryItem.boxItem.blindBox.boxId);
            else location.reload();
        });
    }
</script>

</body>
</html>