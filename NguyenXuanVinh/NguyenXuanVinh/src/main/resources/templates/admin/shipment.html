<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Duy·ªát ƒê∆°n Ship | NXV Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        /* CSS ri√™ng cho b·∫£ng Shipment */
        .ship-card {
            background: #0b0c10;
            border: 1px solid var(--neon-cyan);
            box-shadow: 0 0 15px rgba(102, 252, 241, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }
        .status-select {
            background-color: #1f2833;
            color: #fff;
            border: 1px solid #45a29e;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            outline: none;
            transition: 0.3s;
        }
        .status-select:focus { border-color: #66fcf1; box-shadow: 0 0 8px rgba(102, 252, 241, 0.5); }
        .user-info i { width: 20px; text-align: center; margin-right: 5px; color: #45a29e; }
    </style>
</head>
<body>

<div class="d-flex">
    <div class="sidebar d-flex flex-column" style="min-height: 100vh; width: 260px; background: #0b0c10; border-right: 1px solid #333;">
        <div class="sidebar-brand p-4 text-center border-bottom border-secondary">
            <h4 class="text-info m-0 fw-bold" style="letter-spacing: 2px;"><i class="fas fa-gamepad"></i> ADMIN</h4>
        </div>
        <ul class="nav flex-column mb-auto p-3 gap-2">
            <li class="nav-item"><a href="/admin" class="nav-link text-light"><i class="fas fa-tachometer-alt me-2"></i> Dashboard</a></li>
            <li class="nav-item"><a href="/admin/shipment" class="nav-link active text-dark fw-bold" style="background: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan);"><i class="fas fa-truck-fast me-2"></i> Duy·ªát ƒê∆°n Ship</a></li>
            <li class="nav-item"><a href="/admin/transactions" class="nav-link text-light"><i class="fas fa-file-invoice-dollar me-2"></i> L·ªãch S·ª≠ N·∫°p</a></li>
            <li class="nav-item"><a href="/admin/blindbox" class="nav-link text-light"><i class="fas fa-box me-2"></i> S·∫£n Ph·∫©m</a></li>
            <li class="nav-item mt-5 border-top border-secondary pt-3"><a href="/" class="nav-link text-info"><i class="fas fa-home me-2"></i> V·ªÅ Trang Web</a></li>
        </ul>
    </div>

    <div class="main-content flex-grow-1 p-4" style="background: #1f2833; color: #fff;">

        <h2 class="text-white mb-4" style="text-shadow: 0 0 10px rgba(255,255,255,0.3);">
            <i class="fas fa-shipping-fast text-info"></i> QU·∫¢N L√ù V·∫¨N CHUY·ªÇN
        </h2>

        <div class="ship-card p-3">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle mb-0">
                    <thead>
                    <tr style="color: var(--neon-cyan); border-bottom: 2px solid var(--neon-cyan);">
                        <th>ID</th>
                        <th>Th√¥ng Tin Ng∆∞·ªùi Nh·∫≠n</th>
                        <th>ƒê·ªãa Ch·ªâ Giao H√†ng</th>
                        <th>Ng√†y T·∫°o</th>
                        <th class="text-center">Tr·∫°ng Th√°i</th>
                        <th class="text-center">H√†nh ƒê·ªông</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="ship : ${shipmentRequests}">
                        <td><span class="badge bg-secondary">#<span th:text="${ship.orderId}">123</span></span></td>

                        <td>
                            <div class="fw-bold text-white fs-6" th:text="${ship.receiverName}">Nguyen Van A</div>
                            <div class="user-info small text-muted"><i class="fas fa-phone"></i> <span th:text="${ship.phoneNumber}">098...</span></div>
                        </td>

                        <td style="max-width: 250px;">
                            <div class="text-truncate" th:title="${ship.shippingAddress}">
                                <i class="fas fa-map-marker-alt text-danger me-1"></i> <span th:text="${ship.shippingAddress}">Address...</span>
                            </div>
                            <small class="text-info fst-italic" th:if="${ship.note != null}" th:text="'Ghi ch√∫: ' + ${ship.note}"></small>
                        </td>

                        <td th:text="${#temporals.format(ship.orderDate, 'dd/MM/yyyy HH:mm')}">Date</td>

                        <td class="text-center">
                            <span th:if="${ship.orderStatus == 'PENDING'}" class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Ch·ªù Duy·ªát</span>
                            <span th:if="${ship.orderStatus == 'SHIPPING'}" class="badge bg-primary"><i class="fas fa-truck"></i> ƒêang Giao</span>
                            <span th:if="${ship.orderStatus == 'DELIVERED'}" class="badge bg-success"><i class="fas fa-check-circle"></i> Ho√†n T·∫•t</span>
                            <span th:if="${ship.orderStatus == 'CANCELLED'}" class="badge bg-danger"><i class="fas fa-times-circle"></i> ƒê√£ H·ªßy</span>
                        </td>

                        <td class="text-center">
                            <select class="status-select"
                                    th:onchange="'updateStatus(' + ${ship.orderId} + ', this.value)'"
                                    th:disabled="${ship.orderStatus == 'DELIVERED' or ship.orderStatus == 'CANCELLED'}"
                                    th:style="${ship.orderStatus == 'DELIVERED'} ? 'opacity: 0.5; cursor: not-allowed;' : ''">
                                <option value="" disabled>-- Ch·ªçn --</option>
                                <option value="PENDING" th:selected="${ship.orderStatus == 'PENDING'}">‚è≥ Ch·ªù</option>
                                <option value="SHIPPING" th:if="${ship.orderStatus == 'PENDING'}" class="text-primary fw-bold">üöö G·ª≠i H√†ng</option>
                                <option value="DELIVERED" th:if="${ship.orderStatus == 'SHIPPING'}" class="text-success fw-bold">‚úÖ ƒê√£ Nh·∫≠n</option>
                                <option value="CANCELLED" th:if="${ship.orderStatus != 'DELIVERED'}" class="text-danger">‚ùå H·ªßy ƒê∆°n</option>
                            </select>
                        </td>
                    </tr>

                    <tr th:if="${shipmentRequests.isEmpty()}">
                        <td colspan="6" class="text-center py-5 text-muted">
                            <i class="fas fa-box-open fa-3x mb-3"></i>
                            <p class="mb-0">Hi·ªán t·∫°i ch∆∞a c√≥ y√™u c·∫ßu giao h√†ng n√†o.</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function updateStatus(orderId, newStatus) {
        let titleText = "C·∫≠p nh·∫≠t tr·∫°ng th√°i?";
        let btnColor = "#45a29e";

        if(newStatus === 'SHIPPING') { titleText = "X√°c nh·∫≠n G·ª¨I H√ÄNG cho ƒë∆°n n√†y?"; btnColor = "#3498db"; }
        if(newStatus === 'DELIVERED') { titleText = "X√°c nh·∫≠n kh√°ch ƒê√É NH·∫¨N ƒë∆∞·ª£c h√†ng?"; btnColor = "#2ecc71"; }
        if(newStatus === 'CANCELLED') { titleText = "C·∫£nh b√°o: B·∫°n mu·ªën H·ª¶Y ƒë∆°n n√†y?"; btnColor = "#e74c3c"; }

        Swal.fire({
            title: titleText,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'ƒê·ªìng √Ω',
            confirmButtonColor: btnColor,
            cancelButtonText: 'Quay l·∫°i',
            background: '#111', color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/admin/shipment/update-status', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `orderId=${orderId}&status=${newStatus}`
                })
                .then(res => {
                    if(res.ok) {
                        Swal.fire({ title: 'Th√†nh c√¥ng!', icon: 'success', timer: 1500, showConfirmButton: false, background: '#111', color: '#fff' })
                        .then(() => location.reload());
                    } else {
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t', 'error');
                    }
                });
            } else {
                location.reload();
            }
        });
    }
</script>

</body>
</html>