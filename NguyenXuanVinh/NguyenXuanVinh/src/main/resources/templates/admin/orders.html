<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n L√Ω ƒê∆°n H√†ng | NXV Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">

    <style>
        /* CSS Ri√™ng cho Select Box tr·∫°ng th√°i */
        .status-select {
            background-color: #1f2833;
            color: #fff;
            border: 1px solid #45a29e;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            outline: none;
        }
        .status-select:focus { border-color: #66fcf1; box-shadow: 0 0 5px #66fcf1; }

        .user-info-small { font-size: 13px; color: #aaa; }
        .addr-cell { max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    </style>
</head>
<body>

<div class="d-flex">

    <div class="sidebar d-flex flex-column" style="min-height: 100vh; width: 260px; background: #0b0c10; border-right: 1px solid #333;">
        <div class="sidebar-brand p-3 text-center border-bottom border-secondary">
            <h4 class="text-info m-0"><i class="fas fa-gamepad"></i> NXV ADMIN</h4>
        </div>
        <ul class="nav flex-column mb-auto p-2">
            <li class="nav-item"><a href="/admin" class="nav-link text-light"><i class="fas fa-tachometer-alt me-2"></i> Dashboard</a></li>
            <li class="nav-item"><a href="/admin/orders" class="nav-link active text-info fw-bold" style="background: rgba(102, 252, 241, 0.1);"><i class="fas fa-shopping-cart me-2"></i> ƒê∆°n H√†ng</a></li>
            <li class="nav-item"><a href="/admin/inventory" class="nav-link text-light"><i class="fas fa-warehouse me-2"></i> Kho & C·∫£nh B√°o</a></li>
            <li class="nav-item"><a href="/admin/blindbox" class="nav-link text-light"><i class="fas fa-box me-2"></i> S·∫£n Ph·∫©m</a></li>
            <li class="nav-item"><a href="/admin/news" class="nav-link text-light"><i class="fas fa-newspaper me-2"></i> Tin T·ª©c</a></li>
            <li class="nav-item mt-5"><a href="/" class="nav-link text-info"><i class="fas fa-home me-2"></i> V·ªÅ Trang Web</a></li>
        </ul>
    </div>

    <div class="main-content flex-grow-1 p-4" style="background: #1f2833; color: #fff;">

        <h2 class="text-light mb-4"><i class="fas fa-file-invoice-dollar text-warning"></i> DANH S√ÅCH ƒê∆†N H√ÄNG</h2>

        <div class="neon-card" style="background: #0b0c10; border: 1px solid var(--neon-cyan); padding: 20px; border-radius: 10px;">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle">
                    <thead>
                    <tr class="text-info">
                        <th>ID</th>
                        <th>Kh√°ch H√†ng / SƒêT</th>
                        <th>ƒê·ªãa Ch·ªâ Giao H√†ng</th>
                        <th>Ng√†y ƒê·∫∑t</th>
                        <th>T·ªïng Ti·ªÅn</th>
                        <th>Tr·∫°ng Th√°i</th>
                        <th class="text-center">H√†nh ƒê·ªông</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="order : ${listOrders}">
                        <td><span class="badge bg-secondary">#<span th:text="${order.id}">1</span></span></td>

                        <td>
                            <div class="fw-bold text-white" th:text="${order.receiverName}">Nguyen Van A</div>
                            <div class="user-info-small"><i class="fas fa-phone-alt"></i> <span th:text="${order.phoneNumber}">098...</span></div>
                        </td>

                        <td class="addr-cell" th:title="${order.shippingAddress}">
                            <i class="fas fa-map-marker-alt text-danger"></i> <span th:text="${order.shippingAddress}">H√† N·ªôi...</span>
                        </td>

                        <td th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}">Date</td>

                        <td class="text-warning fw-bold"
                            th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ƒë'">
                        </td>

                        <td>
                            <span th:if="${order.orderStatus == 'PENDING'}" class="badge bg-warning text-dark">‚è≥ Ch·ªù X·ª≠ L√Ω</span>
                            <span th:if="${order.orderStatus == 'SHIPPING'}" class="badge bg-info text-dark">üöö ƒêang Giao</span>
                            <span th:if="${order.orderStatus == 'DELIVERED'}" class="badge bg-success">‚úÖ ƒê√£ Giao</span>
                            <span th:if="${order.orderStatus == 'CANCELLED'}" class="badge bg-danger">‚ùå ƒê√£ H·ªßy</span>
                        </td>

                        <td class="text-center">
                            <select class="status-select"
                                    th:onchange="'updateStatus(' + ${order.id} + ', this.value)'"
                                    th:disabled="${order.orderStatus == 'DELIVERED' or order.orderStatus == 'CANCELLED'}">
                                <option value="" disabled selected>-- Ch·ªçn --</option>
                                <option value="SHIPPING" th:if="${order.orderStatus == 'PENDING'}">üöö G·ª≠i H√†ng</option>
                                <option value="DELIVERED" th:if="${order.orderStatus == 'SHIPPING'}">‚úÖ Ho√†n Th√†nh</option>
                                <option value="CANCELLED" th:if="${order.orderStatus != 'DELIVERED' and order.orderStatus != 'CANCELLED'}">‚ùå H·ªßy ƒê∆°n</option>
                            </select>
                        </td>
                    </tr>

                    <tr th:if="${listOrders.isEmpty()}">
                        <td colspan="7" class="text-center py-5 text-muted">
                            <i class="fas fa-box-open fa-3x mb-3"></i>
                            <p>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function updateStatus(orderId, newStatus) {
        let actionText = "";
        if(newStatus === 'SHIPPING') actionText = "B·∫Øt ƒë·∫ßu giao h√†ng?";
        else if(newStatus === 'DELIVERED') actionText = "X√°c nh·∫≠n ƒë√£ giao th√†nh c√¥ng?";
        else if(newStatus === 'CANCELLED') actionText = "B·∫°n ch·∫Øc ch·∫Øn mu·ªën H·ª¶Y ƒë∆°n n√†y?";

        Swal.fire({
            title: 'X√°c Nh·∫≠n',
            text: actionText,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'ƒê·ªìng √Ω',
            confirmButtonColor: '#66fcf1',
            cancelButtonColor: '#333',
            background: '#111', color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                // G·ªçi API c·∫≠p nh·∫≠t
                fetch('/admin/shipment/update-status', { // L∆∞u √Ω URL n√†y kh·ªõp v·ªõi Controller Admin
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `orderId=${orderId}&status=${newStatus}`
                })
                .then(res => {
                    if(res.ok) {
                        Swal.fire({ title: 'Th√†nh c√¥ng!', icon: 'success', timer: 1500, showConfirmButton: false, background: '#111', color: '#fff' })
                        .then(() => location.reload());
                    } else {
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t', 'error');
                    }
                })
                .catch(() => Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi server', 'error'));
            } else {
                location.reload(); // Reset l·∫°i dropdown n·∫øu h·ªßy ch·ªçn
            }
        });
    }
</script>
</body>
</html>