<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Blind Box Shop - Gacha Game</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<header>
    <div class="logo">ğŸ Mystery Box</div>
    <div class="user-info" th:if="${user != null}">
        <span>Xin chÃ o, <b th:text="${user.fullName}">User</b></span>
        <div class="wallet">
            ğŸ’° <span th:text="${#numbers.formatDecimal(user.walletBalance, 0, 'COMMA', 0, 'POINT')}">0</span> VNÄ
        </div>
    </div>
</header>

<div class="container">
    <h1 class="title">âœ¨ SÃ€N Äáº¤U NHÃ‚N PHáº¨M âœ¨</h1>

    <div class="box-grid">
        <div class="box-card" th:each="box : ${boxes}">
            <div class="box-image">
                <img th:src="${box.imageUrl != null ? box.imageUrl : 'https://cdn-icons-png.flaticon.com/512/4531/4531990.png'}" alt="Box Image">
            </div>
            <div class="box-info">
                <h3 th:text="${box.boxName}">TÃªn Há»™p</h3>
                <p class="price" th:text="${#numbers.formatDecimal(box.price, 0, 'COMMA', 0, 'POINT')} + ' Ä‘'">100.000 Ä‘</p>

                <button class="btn-buy" th:onclick="'openBox(' + ${box.boxId} + ')'">ğŸ”¥ Má» NGAY</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // HÃ m gá»i API Má»Ÿ Há»™p
    function openBox(boxId) {
        // ID User táº¡m thá»i fix cá»©ng lÃ  1 (sau nÃ y sáº½ láº¥y tá»« session)
        const userId = 1;

        // Hiá»‡n thÃ´ng bÃ¡o Ä‘ang xá»­ lÃ½...
        Swal.fire({
            title: 'Äang má»Ÿ há»™p...',
            html: 'Chá» xÃ­u nhÃ©, Ä‘ang cáº§u nguyá»‡n nhÃ¢n pháº©m! ğŸ™',
            timerProgressBar: true,
            didOpen: () => { Swal.showLoading() }
        });

        // Gá»i API Backend (POST)
        fetch(`/api/blindbox/open?userId=${userId}&boxId=${boxId}`, {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) throw new Error("Lá»—i máº¡ng hoáº·c háº¿t tiá»n!");
            return response.json();
        })
        .then(data => {
            // Xá»­ lÃ½ káº¿t quáº£ tráº£ vá» tá»« Backend
            showResult(data);
        })
        .catch(error => {
            Swal.fire('Lá»—i!', 'Báº¡n khÃ´ng Ä‘á»§ tiá»n hoáº·c cÃ³ lá»—i xáº£y ra.', 'error');
        });
    }

    // HÃ m hiá»ƒn thá»‹ káº¿t quáº£ trÃºng thÆ°á»Ÿng
    function showResult(data) {
       // Kiá»ƒm tra Ä‘á»™ hiáº¿m Ä‘á»ƒ Ä‘á»•i mÃ u tiÃªu Ä‘á»
let titleColor = '#000';
if (data.rarity === 'S') titleColor = '#ffd700'; // VÃ ng
else if (data.rarity === 'A') titleColor = '#c92a2a'; // Äá»
else if (data.rarity === 'B') titleColor = '#9b59b6'; // TÃ­m (ThÃªm cÃ¡i nÃ y náº¿u thÃ­ch)
else if (data.rarity === 'C') titleColor = '#3498db'; // Xanh dÆ°Æ¡ng (Má»›i thÃªm)

        Swal.fire({
            title: `<span style="color:${titleColor}">ğŸ‰ Báº N TRÃšNG: ${data.rarity} ğŸ‰</span>`,
            html: `
                <div style="text-align:center">
                    <img src="${data.itemImage || 'https://via.placeholder.com/150'}" style="width:150px; margin:10px auto; display:block; border-radius:10px;">
                    <h3>${data.itemName}</h3>
                    <p>Sá»‘ dÆ° cÃ²n láº¡i: <b>${new Intl.NumberFormat().format(data.currentBalance)} Ä‘</b></p>
                </div>
            `,
            confirmButtonText: 'Tuyá»‡t vá»i!',
            background: '#fff url(/images/confetti.gif)' // Náº¿u cÃ³ áº£nh phÃ¡o hoa thÃ¬ thÃªm vÃ o
        }).then(() => {
            // Sau khi táº¯t popup thÃ¬ load láº¡i trang Ä‘á»ƒ cáº­p nháº­t sá»‘ dÆ°
            location.reload();
        });
    }
</script>

</body>
</html>