<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Blind Box Shop - Gacha Game</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<header>
    <div class="logo">
        <a href="/" style="text-decoration:none; color:#ff4757;"><i class="fas fa-gift"></i> Mystery Box</a>
    </div>

    <div class="search-bar">
        <form action="/" method="get">
            <input type="text" name="keyword" placeholder="Báº¡n muá»‘n tÃ¬m há»™p gÃ¬..." th:value="${keyword}">
            <button type="submit"><i class="fas fa-search"></i></button>
        </form>
    </div>

    <div class="menu">
        <a href="/" class="nav-link active">ğŸ  Trang Chá»§</a>
        <a href="/cart" class="nav-link">ğŸ›’ Giá» HÃ ng</a>
        <a href="/inventory" class="nav-link">ğŸ’ Kho Äá»“</a>
        <a href="/deposit" class="nav-link deposit-btn">ğŸ’ Náº¡p Xu</a>
        <a href="/admin" class="nav-link admin-btn" th:if="${user != null and user.isAdmin}">ğŸ› ï¸ Quáº£n Trá»‹</a>
    </div>

    <div class="user-info" th:if="${user != null}">
        <div class="user-details">
            <a href="/profile" style="color: #fff; text-decoration: none; font-weight: 600;">
                Xin chÃ o, <span th:text="${user.fullName}">User</span>
            </a>
            <br>
            <a href="/logout" class="logout-link">ğŸšª ÄÄƒng xuáº¥t</a>
        </div>
        <div class="wallet">
            ğŸ’° <span th:text="${#numbers.formatDecimal(user.walletBalance, 0, 'COMMA', 0, 'POINT')}">0</span> VNÄ
        </div>
    </div>

    <div class="user-info" th:if="${user == null}">
        <a href="/login" class="btn-buy" style="padding: 8px 20px; text-decoration: none;">ÄÄƒng Nháº­p</a>
    </div>
</header>

<section class="hero-banner">
    <div class="hero-content">
        <h1>SÄ‚N Gáº¤U BÃ”NG - THá»¬ Váº¬N MAY</h1>
        <p>Má»Ÿ há»™p bÃ­ máº­t, sá»Ÿ há»¯u ngay nhá»¯ng váº­t pháº©m giá»›i háº¡n cá»±c hiáº¿m!</p>
        <button class="hero-btn" onclick="scrollToShop()">KHÃM PHÃ NGAY</button>
    </div>
</section>

<div class="container" id="shop-section">
    <h2 class="section-title">ğŸ”¥ Há»˜P MÃ™ ÄANG HOT ğŸ”¥</h2>
    <div th:if="${boxes.isEmpty()}" style="text-align: center; margin-top: 50px; color: #888;">
        <h2>ğŸ” KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m nÃ o!</h2>
        <p>Thá»­ tÃ¬m tá»« khÃ³a khÃ¡c xem sao...</p>
        <a href="/" class="btn-buy" style="margin-top: 20px; display: inline-block;">Vá» xem táº¥t cáº£</a>
    </div>
    <div class="box-grid">
        <div class="box-card" th:each="box : ${boxes}">
            <div class="box-image">
                <a th:href="@{/box/{id}(id=${box.boxId})}">
                    <img th:src="${box.imageUrl}" alt="Box Image">
                </a>
                <span class="hot-badge">HOT</span>
            </div>
            <div class="box-info">
                <a th:href="@{/box/{id}(id=${box.boxId})}" style="text-decoration: none;">
                    <h3 th:text="${box.boxName}">TÃªn Há»™p</h3>
                </a>

                <p class="desc" th:text="${box.description}">MÃ´ táº£ ngáº¯n...</p>
                <div class="price-tag" th:text="${#numbers.formatDecimal(box.price, 0, 'COMMA', 0, 'POINT')} + ' Ä‘'">100.000 Ä‘</div>

                <div class="action-buttons">
                    <button class="btn-buy" th:onclick="'openBox(' + ${box.boxId} + ')'"><i class="fas fa-magic"></i> Má» NGAY</button>
                    <button class="btn-cart" th:onclick="'addToCart(' + ${box.boxId} + ')'"><i class="fas fa-cart-plus"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<footer style="text-align: center; padding: 20px; color: #666; margin-top: 50px;">
    <p>&copy; 2025 Mystery Box Shop. Design by Nguyen Xuan Vinh.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:inline="javascript">
    function scrollToShop() {
        document.getElementById('shop-section').scrollIntoView({behavior: 'smooth'});
    }

    function openBox(boxId) {
        const userId = [[${user != null ? user.userId : 'null'}]];
        if (userId === 'null') { promptLogin(); return; }

        Swal.fire({
            title: 'Äang má»Ÿ há»™p...',
            html: 'Chá» xÃ­u nhÃ©, Ä‘ang cáº§u nguyá»‡n nhÃ¢n pháº©m! ğŸ™',
            timerProgressBar: true,
            didOpen: () => { Swal.showLoading() }
        });

        fetch(`/api/blindbox/open?userId=${userId}&boxId=${boxId}`, { method: 'POST' })
        .then(res => {
            if (!res.ok) throw new Error("Tiá»n khÃ´ng Ä‘á»§ hoáº·c lá»—i máº¡ng");
            return res.json();
        })
        .then(data => showResult(data))
        .catch(() => Swal.fire('Lá»—i!', 'Báº¡n khÃ´ng Ä‘á»§ tiá»n hoáº·c cÃ³ lá»—i xáº£y ra.', 'error'));
    }

    function addToCart(boxId) {
        const userId = [[${user != null ? user.userId : 'null'}]];
        if (userId === 'null') { promptLogin(); return; }

        fetch(`/api/cart/add?userId=${userId}&boxId=${boxId}`, { method: 'POST' })
        .then(res => {
            if(res.ok) {
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 2000,
                    didOpen: (toast) => { 
                        toast.addEventListener('mouseenter', Swal.stopTimer);
                        toast.addEventListener('mouseleave', Swal.resumeTimer);
                    }
                })
                Toast.fire({ icon: 'success', title: 'ÄÃ£ thÃªm vÃ o giá»!' })
            } else {
                Swal.fire('Lá»—i', 'KhÃ´ng thá»ƒ thÃªm vÃ o giá»', 'error');
            }
        });
    }

    function showResult(data) {
        let titleColor = '#000';
        if(data.rarity === 'S') titleColor = '#ffd700';
        else if(data.rarity === 'A') titleColor = '#c92a2a';
        else if(data.rarity === 'B') titleColor = '#9b59b6';
        else if(data.rarity === 'C') titleColor = '#3498db';

        Swal.fire({
            title: `<span style="color:${titleColor}">ğŸ‰ Báº N TRÃšNG: ${data.rarity} ğŸ‰</span>`,
            html: `
                <div style="text-align:center">
                    <img src="${data.itemImage}" style="width:150px; margin:10px auto; border-radius:10px; box-shadow:0 0 15px ${titleColor}">
                    <h3>${data.itemName}</h3>
                    <p>Sá»‘ dÆ° cÃ²n láº¡i: <b>${new Intl.NumberFormat().format(data.currentBalance)} Ä‘</b></p>
                </div>
            `,
            confirmButtonText: 'Tuyá»‡t vá»i!',
            background: '#fff url(/images/confetti.gif)'
        }).then(() => location.reload());
    }

    function promptLogin() {
        Swal.fire({ 
            title: 'ChÆ°a Ä‘Äƒng nháº­p!', 
            text: 'Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ tiáº¿p tá»¥c.', 
            icon: 'warning', 
            confirmButtonText: 'ÄÄƒng nháº­p ngay' 
        })
        .then((res) => { 
            if(res.isConfirmed) window.location.href='/login'; 
        });
    }
</script>
</body>
</html>