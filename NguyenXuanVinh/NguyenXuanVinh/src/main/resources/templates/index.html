<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Blind Box Shop - Gacha Game</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/style.css">

    <style>
        /* Tinh chá»‰nh Carousel */
        .carousel-item { height: 500px; background-color: #000; }
        .carousel-item img { height: 100%; object-fit: cover; opacity: 0.8; }
        .carousel-caption {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
        }

        /* Danh má»¥c (Category) */
        .category-bar {
            display: flex; gap: 20px; overflow-x: auto; padding: 20px 0;
            justify-content: center; flex-wrap: wrap;
        }
        .cat-item {
            background: var(--bg-card);
            padding: 15px 25px;
            border-radius: 50px;
            border: 1px solid var(--neon-blue);
            color: #fff; text-decoration: none; font-weight: bold;
            display: flex; align-items: center; gap: 10px;
            transition: 0.3s;
        }
        .cat-item:hover {
            background: var(--neon-cyan); color: #000; transform: scale(1.05);
            box-shadow: 0 0 15px var(--neon-cyan);
        }
        .cat-img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }

        /* Tin tá»©c (News Grid) */
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .news-card {
            background: var(--bg-card); border: 1px solid #333; border-radius: 10px; overflow: hidden; transition: 0.3s;
            display: flex; flex-direction: column; height: 100%;
        }
        .news-card:hover { border-color: var(--neon-pink); transform: translateY(-5px); }
        .news-thumb { height: 180px; width: 100%; object-fit: cover; }
        .news-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .news-title { color: var(--neon-cyan); font-size: 16px; font-weight: bold; margin-bottom: 10px; }
        .news-date { font-size: 12px; color: #888; margin-top: auto; }

        /* Bootstrap override for dark mode consistency */
        .carousel-indicators [data-bs-target] { background-color: var(--neon-cyan); }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <a href="/" style="text-decoration:none; color:#66fcf1;"><i class="fas fa-gift"></i> Mystery Box</a>
    </div>

    <div class="search-bar">
        <form action="/" method="get">
            <input type="text" name="keyword" placeholder="Báº¡n muá»‘n tÃ¬m há»™p gÃ¬..." th:value="${keyword}">
            <button type="submit"><i class="fas fa-search"></i></button>
        </form>
    </div>

    <div class="menu">
        <a href="/" class="nav-link active">ğŸ  Trang Chá»§</a>
        <a href="/cart" class="nav-link">ğŸ›’ Giá» HÃ ng</a>
        <a href="/inventory" class="nav-link">ğŸ’ Kho Äá»“</a>
        <a href="/deposit" class="nav-link deposit-btn">ğŸ’ Náº¡p Xu</a>

        <a href="/admin" class="nav-link"
           style="border: 1px solid #ff4757; color: #ff4757;"
           th:if="${nxvUser != null and nxvUser.isAdmin}">ğŸ› ï¸ Quáº£n Trá»‹</a>
    </div>

    <div class="user-info" th:if="${nxvUser != null}">
        <div class="user-details">
            <a href="/profile" style="color: #fff; text-decoration: none; font-weight: 600;">
                Hello, <span th:text="${nxvUser.fullName}" style="color: #66fcf1;">User</span>
            </a>
            <br>
            <a href="/logout" class="logout-link">ğŸšª ÄÄƒng xuáº¥t</a>
        </div>
        <div class="wallet">
            ğŸ’° <span th:text="${#numbers.formatDecimal(nxvUser.walletBalance, 0, 'COMMA', 0, 'POINT')}">0</span> Ä‘
        </div>
    </div>

    <div class="user-info" th:if="${nxvUser == null}">
        <a href="/login" class="btn-buy" style="padding: 8px 20px; text-decoration: none; width: auto; margin: 0;">ÄÄƒng Nháº­p</a>
    </div>
</header>

<div th:if="${banners == null or banners.isEmpty()}" class="hero-banner">
    <div class="hero-content">
        <h1>SÄ‚N Gáº¤U BÃ”NG - THá»¬ Váº¬N MAY</h1>
        <p>Má»Ÿ há»™p bÃ­ máº­t, sá»Ÿ há»¯u ngay nhá»¯ng váº­t pháº©m giá»›i háº¡n cá»±c hiáº¿m!</p>
        <button class="hero-btn" onclick="scrollToShop()">KHÃM PHÃ NGAY</button>
    </div>
</div>

<div th:unless="${banners == null or banners.isEmpty()}" id="homeCarousel" class="carousel slide mb-5" data-bs-ride="carousel">
    <div class="carousel-indicators">
        <button th:each="b, iter : ${banners}" type="button" data-bs-target="#homeCarousel"
                th:data-bs-slide-to="${iter.index}" th:classappend="${iter.index == 0} ? 'active'"></button>
    </div>
    <div class="carousel-inner">
        <div th:each="b, iter : ${banners}" class="carousel-item" th:classappend="${iter.index == 0} ? 'active'">
            <a th:href="${b.linkUrl}">
                <img th:src="${b.imageUrl}" class="d-block w-100" alt="Banner">
            </a>
            <div class="carousel-caption d-none d-md-block">
                <h2 th:text="${b.title}" style="color: var(--neon-cyan); text-transform: uppercase; font-weight: 800;">TiÃªu Ä‘á»</h2>
                <button class="hero-btn mt-2" onclick="scrollToShop()">Xem Ngay</button>
            </div>
        </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#homeCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#homeCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
    </button>
</div>

<div class="container mb-5">
    <h5 class="text-center text-light mb-3" style="letter-spacing: 2px;">DANH Má»¤C KHÃM PHÃ</h5>
    <div class="category-bar">
        <a href="/" class="cat-item">
            <i class="fas fa-th-large"></i> Táº¥t cáº£
        </a>
        <a th:each="cat : ${categories}" th:href="@{/(keyword=${cat.categoryName})}" class="cat-item">
            <img th:if="${cat.imageUrl != null}" th:src="${cat.imageUrl}" class="cat-img">
            <i th:if="${cat.imageUrl == null}" class="fas fa-cube"></i>
            <span th:text="${cat.categoryName}">Anime</span>
        </a>
    </div>
</div>

<div class="container" id="shop-section">
    <h2 class="section-title">ğŸ”¥ Há»˜P MÃ™ ÄANG HOT ğŸ”¥</h2>

    <div th:if="${boxes.isEmpty()}" style="text-align: center; margin-top: 50px; color: #888;">
        <h2>ğŸ” KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m nÃ o!</h2>
        <a href="/" class="btn-buy" style="margin-top: 20px; display: inline-block; width: auto; padding: 10px 30px;">Vá» xem táº¥t cáº£</a>
    </div>

    <div class="box-grid">
        <div class="box-card" th:each="box : ${boxes}">
            <div class="box-image">
                <a th:href="@{/box/{id}(id=${box.boxId})}">
                    <img th:src="${box.imageUrl != null ? box.imageUrl : '/images/box-default.jpg'}" alt="Box Image">
                </a>
                <span class="hot-badge" th:if="${box.isActive}">HOT</span>
            </div>
            <div class="box-info">
                <a th:href="@{/box/{id}(id=${box.boxId})}" style="text-decoration: none;">
                    <h3 th:text="${box.boxName}">TÃªn Há»™p</h3>
                </a>

                <small style="color: #888; display: block; margin-bottom: 5px;"
                       th:text="${box.nxvCategory != null ? box.nxvCategory.categoryName : 'Mystery'}"></small>

                <p class="price-tag" th:text="${#numbers.formatDecimal(box.price, 0, 'COMMA', 0, 'POINT')} + ' Ä‘'">100.000 Ä‘</p>

                <div class="action-buttons">
                    <button class="btn-buy" th:onclick="'openBox(' + ${box.boxId} + ')'"><i class="fas fa-magic"></i> Má» NGAY</button>
                    <button class="btn-cart" th:onclick="'addToCart(' + ${box.boxId} + ')'"><i class="fas fa-cart-plus"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5 pt-5" th:if="${newsList != null and !newsList.isEmpty()}">
    <h2 class="section-title" style="border-color: var(--neon-pink); color: var(--neon-pink);">ğŸ“° TIN Tá»¨C & Sá»° KIá»†N</h2>

    <div class="news-grid">
        <div class="news-card" th:each="news : ${newsList}">
            <img th:src="${news.thumbnail}" class="news-thumb">
            <div class="news-body">
                <div class="news-title" th:text="${news.title}">TiÃªu Ä‘á» tin tá»©c</div>
                <p style="font-size: 13px; color: #ccc;"
                   th:text="${#strings.abbreviate(news.content, 80)}">Ná»™i dung tÃ³m táº¯t...</p>

                <div class="d-flex justify-content-between align-items-center mt-auto">
                    <span class="news-date"><i class="far fa-clock"></i> <span th:text="${#temporals.format(news.publishedAt, 'dd/MM/yyyy')}"></span></span>
                    <a th:href="@{/news/{id}(id=${news.newsId})}" style="color: var(--neon-cyan); font-size: 13px; font-weight: bold;">Xem thÃªm &rarr;</a>
                </div>
            </div>
        </div>
    </div>
</div>

<footer style="text-align: center; padding: 30px; color: #666; margin-top: 50px; border-top: 1px solid #1f2833;">
    <p>&copy; 2025 Mystery Box Shop. Design by Nguyen Xuan Vinh.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script th:inline="javascript">
    function scrollToShop() {
        document.getElementById('shop-section').scrollIntoView({behavior: 'smooth'});
    }

    // --- HÃ€M Má» Há»˜P (GACHA) ---
    function openBox(boxId) {
        const userId = [[${nxvUser != null ? nxvUser.userId : 'null'}]];

        if (userId === 'null' || userId === null) {
            promptLogin();
            return;
        }

        Swal.fire({
            title: 'Äang má»Ÿ há»™p...',
            html: 'Chá» xÃ­u nhÃ©, Ä‘ang cáº§u nguyá»‡n nhÃ¢n pháº©m! ğŸ™',
            timerProgressBar: true,
            didOpen: () => { Swal.showLoading() }
        });

        fetch(`/api/blindbox/open?userId=${userId}&boxId=${boxId}`, { method: 'POST' })
        .then(res => {
            if (!res.ok) throw new Error("Tiá»n khÃ´ng Ä‘á»§ hoáº·c lá»—i máº¡ng");
            return res.json();
        })
        .then(data => showResult(data))
        .catch(() => Swal.fire('Lá»—i!', 'Báº¡n khÃ´ng Ä‘á»§ tiá»n hoáº·c cÃ³ lá»—i xáº£y ra.', 'error'));
    }

    // --- HÃ€M THÃŠM GIá» HÃ€NG ---
    function addToCart(boxId) {
        const userId = [[${nxvUser != null ? nxvUser.userId : 'null'}]];
        if (userId === 'null' || userId === null) { promptLogin(); return; }

        fetch(`/api/cart/add?userId=${userId}&boxId=${boxId}`, { method: 'POST' })
        .then(res => {
            if(res.ok) {
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 2000,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer);
                        toast.addEventListener('mouseleave', Swal.resumeTimer);
                    }
                })
                Toast.fire({ icon: 'success', title: 'ÄÃ£ thÃªm vÃ o giá»!' })
            } else {
                Swal.fire('Lá»—i', 'KhÃ´ng thá»ƒ thÃªm vÃ o giá»', 'error');
            }
        });
    }

    // --- HIá»‚N THá»Š Káº¾T QUáº¢ ---
    function showResult(data) {
        let titleColor = '#000';
        if(data.rarity === 'S') titleColor = '#ffd700';
        else if(data.rarity === 'A') titleColor = '#ff4757';
        else if(data.rarity === 'B') titleColor = '#9b59b6';
        else if(data.rarity === 'C') titleColor = '#3498db';

        Swal.fire({
            title: `<span style="color:${titleColor}">ğŸ‰ Báº N TRÃšNG: ${data.rarity} ğŸ‰</span>`,
            html: `
                <div style="text-align:center">
                    <img src="${data.itemImage}" style="width:150px; margin:10px auto; border-radius:10px; box-shadow:0 0 15px ${titleColor}">
                    <h3>${data.itemName}</h3>
                    <p>Sá»‘ dÆ° cÃ²n láº¡i: <b>${new Intl.NumberFormat().format(data.currentBalance)} Ä‘</b></p>
                    <a href="/inventory" class="btn btn-sm btn-outline-primary mt-2">Xem kho Ä‘á»“</a>
                </div>
            `,
            confirmButtonText: 'Tuyá»‡t vá»i!',
            background: '#fff'
        });
        // KhÃ´ng reload Ä‘á»ƒ user tiáº¿p tá»¥c mua náº¿u muá»‘n
    }

    function promptLogin() {
        Swal.fire({
            title: 'ChÆ°a Ä‘Äƒng nháº­p!',
            text: 'Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ tiáº¿p tá»¥c.',
            icon: 'warning',
            confirmButtonText: 'ÄÄƒng nháº­p ngay'
        })
        .then((res) => {
            if(res.isConfirmed) window.location.href='/login';
        });
    }
</script>
</body>
</html>