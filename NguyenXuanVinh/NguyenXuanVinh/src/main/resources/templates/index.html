<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Blind Box Shop - Gacha Game</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">

    <style>
        /* CSS Ri√™ng cho trang ch·ªß */
        .carousel-item { height: 500px; background-color: #000; }
        .carousel-item img { height: 100%; object-fit: cover; opacity: 0.8; }
        .carousel-caption {
            background: rgba(0, 0, 0, 0.6); padding: 20px; border-radius: 10px;
            border: 1px solid var(--neon-cyan); box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
        }

        /* Top User Card */
        .top1-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(0,0,0,0.8));
            border: 2px solid #ffd700; border-radius: 15px; padding: 20px;
            text-align: center; position: relative; box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
        }
        .crown-icon { font-size: 40px; color: #ffd700; margin-bottom: 10px; filter: drop-shadow(0 0 10px #ffd700); }
        .top1-avatar { width: 100px; height: 100px; border: 3px solid #ffd700; border-radius: 50%; object-fit: cover; }

        /* Top List */
        .top-list-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.05);
            border-radius: 10px; border: 1px solid #333; transition: 0.3s;
        }
        .top-list-item:hover { border-color: var(--neon-cyan); background: rgba(102, 252, 241, 0.05); }
        .rank-number {
            width: 30px; height: 30px; border-radius: 50%; background: #333;
            color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px;
        }
        .rank-2 { background: #C0C0C0; color: #000; }
        .rank-3 { background: #CD7F32; color: #000; }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <a href="/" style="text-decoration:none; color:#66fcf1;"><i class="fas fa-gift"></i> Mystery Box</a>
    </div>

    <div class="search-bar">
        <form action="/" method="get">
            <input type="text" name="keyword" placeholder="B·∫°n mu·ªën t√¨m h·ªôp g√¨..." th:value="${keyword}">
            <button type="submit"><i class="fas fa-search"></i></button>
        </form>
    </div>

    <div class="menu">
        <a href="/" class="nav-link active">üè† Trang Ch·ªß</a>
        <a href="/cart" class="nav-link">üõí Gi·ªè H√†ng</a>
        <a href="/inventory" class="nav-link">üéí Kho ƒê·ªì</a>
        <a href="/deposit" class="nav-link deposit-btn">üíé N·∫°p Xu</a>
        <a href="/admin" class="nav-link admin-btn" th:if="${nxvUser != null and nxvUser.isAdmin}">üõ†Ô∏è Qu·∫£n Tr·ªã</a>
    </div>

    <div class="user-info d-flex align-items-center" th:if="${nxvUser != null}">
        <div class="wallet-badge me-3" title="S·ªë D∆∞ Hi·ªán T·∫°i">
            <i class="fas fa-coins wallet-icon"></i>
            <span id="wallet-balance" class="wallet-amount" th:text="${#numbers.formatDecimal(nxvUser.walletBalance, 0, 'COMMA', 0, 'POINT')}">0</span>
            <small class="currency">ƒë</small>
        </div>

        <div class="user-dropdown-container">
            <div class="user-trigger">
                <span class="username d-none d-lg-inline me-2" th:text="${nxvUser.username}">User</span>
                <img th:src="'https://ui-avatars.com/api/?background=random&color=fff&name=' + ${nxvUser.fullName}" class="user-avatar-glow">
            </div>

            <div class="dropdown-menu-custom">
                <div class="dropdown-header-info">
                    Xin ch√†o, <b th:text="${nxvUser.fullName}" style="color: #fff;">Name</b>
                </div>
                <a href="/profile" class="dropdown-item-custom"><i class="fas fa-id-card"></i> H·ªì S∆° C√° Nh√¢n</a>
                <a href="/inventory" class="dropdown-item-custom"><i class="fas fa-box-open"></i> Kho ƒê·ªì</a>
                <a href="/shipment/history" class="dropdown-item-custom"><i class="fas fa-history"></i> L·ªãch S·ª≠ Giao D·ªãch</a>
                <a href="/logout" class="dropdown-item-custom logout"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</a>
            </div>
        </div>
    </div>

    <div class="user-info" th:if="${nxvUser == null}">
        <a href="/login" class="btn-buy" style="padding: 8px 25px; text-decoration: none; display: inline-block;">ƒêƒÉng Nh·∫≠p</a>
    </div>
</header>

<div th:unless="${banners == null or banners.isEmpty()}" id="homeCarousel" class="carousel slide mb-5" data-bs-ride="carousel">
    <div class="carousel-indicators">
        <button th:each="b, iter : ${banners}" type="button" data-bs-target="#homeCarousel"
                th:data-bs-slide-to="${iter.index}" th:classappend="${iter.index == 0} ? 'active'"></button>
    </div>
    <div class="carousel-inner">
        <div th:each="b, iter : ${banners}" class="carousel-item" th:classappend="${iter.index == 0} ? 'active'">
            <a th:href="${b.linkUrl}">
                <img th:src="${b.imageUrl}" class="d-block w-100" alt="Banner">
            </a>
            <div class="carousel-caption d-none d-md-block">
                <h2 th:text="${b.title}" style="color: var(--neon-cyan); text-transform: uppercase; font-weight: 800;">Ti√™u ƒê·ªÅ</h2>
                <button class="hero-btn mt-2" onclick="scrollToShop()">Xem Ngay</button>
            </div>
        </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#homeCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
    <button class="carousel-control-next" type="button" data-bs-target="#homeCarousel" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
</div>

<div class="container mb-5" th:if="${topUsers != null and !topUsers.isEmpty()}">
    <h3 class="section-title" style="color: #ffd700; border-bottom-color: #ffd700; text-shadow: 0 0 10px #ffd700;">
        <i class="fas fa-crown"></i> B·∫¢NG X·∫æP H·∫†NG ƒê·∫†I GIA
    </h3>
    <div class="row align-items-center">
        <div class="col-md-5 mb-4 mb-md-0" th:if="${topUsers.size() > 0}">
            <div class="top1-card">
                <div class="crown-icon"><i class="fas fa-crown"></i></div>
                <img th:src="'https://ui-avatars.com/api/?size=200&background=random&color=fff&name=' + ${topUsers[0].user.fullName}" class="top1-avatar mb-3">
                <h2 class="text-white fw-bold" th:text="${topUsers[0].user.username}">King</h2>
                <div class="badge bg-warning text-dark fs-5 mt-2">TOP 1 SERVER</div>
                <h3 class="mt-3" style="color: #ffd700; text-shadow: 0 0 10px #ffd700;">
                    <span th:text="${#numbers.formatDecimal(topUsers[0].totalAmount, 0, 'COMMA', 0, 'POINT')}">0</span> ƒë
                </h3>
            </div>
        </div>
        <div class="col-md-7">
            <div class="list-group">
                <div th:each="top, iter : ${topUsers}" th:if="${iter.index > 0}" class="top-list-item">
                    <div class="d-flex align-items-center">
                        <div class="rank-number"
                             th:classappend="${iter.index == 1} ? 'rank-2' : (${iter.index == 2} ? 'rank-3' : '')"
                             th:text="${iter.count}">2</div>
                        <img th:src="'https://ui-avatars.com/api/?background=random&color=fff&name=' + ${top.user.fullName}"
                             class="rounded-circle me-3" width="40" height="40">
                        <div>
                            <div class="fw-bold text-light" th:text="${top.user.username}">User</div>
                            <small class="text-muted">ƒê·∫°i gia ng·∫ßm</small>
                        </div>
                    </div>
                    <div class="fw-bold text-info">
                        <span th:text="${#numbers.formatDecimal(top.totalAmount, 0, 'COMMA', 0, 'POINT')}">0</span> ƒë
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container" id="shop-section">
    <h2 class="section-title">üî• H·ªòP M√ô ƒêANG HOT üî•</h2>
    <div class="box-grid">
        <div class="box-card" th:each="box : ${boxes}">
            <div class="box-image">
                <a th:href="@{/box/{id}(id=${box.boxId})}">
                    <img th:src="${box.imageUrl != null ? box.imageUrl : '/images/box-default.jpg'}" alt="Box Image">
                </a>
                <span class="hot-badge" th:if="${box.isActive}">HOT</span>
            </div>
            <div class="box-info">
                <a th:href="@{/box/{id}(id=${box.boxId})}" style="text-decoration: none;">
                    <h3 th:text="${box.boxName}">T√™n H·ªôp</h3>
                </a>
                <div class="price-tag" th:text="${#numbers.formatDecimal(box.price, 0, 'COMMA', 0, 'POINT')} + ' ƒë'">100.000 ƒë</div>
                <div class="action-buttons">
                    <button class="btn-buy" th:onclick="'openBox(' + ${box.boxId} + ')'"><i class="fas fa-magic"></i> M·ªû NGAY</button>
                    <button class="btn-cart" th:onclick="'addToCart(' + ${box.boxId} + ')'"><i class="fas fa-cart-plus"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5 pt-5" th:if="${newsList != null and !newsList.isEmpty()}">
    <h2 class="section-title" style="border-color: var(--neon-pink); color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink);">üì∞ TIN T·ª®C & S·ª∞ KI·ªÜN</h2>
    <div class="news-grid">
        <div class="news-card" th:each="news : ${newsList}">
            <img th:src="${news.thumbnail}" class="news-thumb">
            <div class="news-body">
                <div class="news-title" th:text="${news.title}">Ti√™u ƒë·ªÅ tin t·ª©c</div>
                <div class="d-flex justify-content-between align-items-center mt-auto">
                    <span class="news-date"><i class="far fa-clock"></i> <span th:text="${#temporals.format(news.publishedAt, 'dd/MM/yyyy')}"></span></span>
                    <a th:href="@{/news/{id}(id=${news.newsId})}" style="color: var(--neon-cyan); font-size: 13px; font-weight: bold;">Xem th√™m &rarr;</a>
                </div>
            </div>
        </div>
    </div>
</div>

<footer style="text-align: center; padding: 30px; color: #666; margin-top: 50px; border-top: 1px solid #1f2833;">
    <p>&copy; 2025 Mystery Box Shop. Design by Nguyen Xuan Vinh.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script th:inline="javascript">
    function scrollToShop() {
        document.getElementById('shop-section').scrollIntoView({behavior: 'smooth'});
    }

    // --- LOGIC M·ªû H·ªòP (ƒê·ªÜ QUY) ---
    function openBox(boxId) {
        // L·∫•y userId t·ª´ Thymeleaf (An to√†n null)
        const userId = [[${nxvUser != null ? nxvUser.userId : 'null'}]];

        // Check ƒëƒÉng nh·∫≠p
        if (userId === 'null') { promptLogin(); return; }

        // Hi·ªÉn th·ªã Loading ƒë·∫πp
        Swal.fire({
            title: 'ƒêang m·ªü h·ªôp...',
            html: 'Ch·ªù x√≠u nh√©, ƒëang c·∫ßu nguy·ªán nh√¢n ph·∫©m! üôè',
            timerProgressBar: true,
            background: '#111', color: '#fff',
            didOpen: () => { Swal.showLoading() }
        });

        // G·ªçi API
        fetch(`/api/blindbox/open?userId=${userId}&boxId=${boxId}`, { method: 'POST' })
        .then(res => {
            if (!res.ok) throw new Error("L·ªói");
            return res.json();
        })
        .then(data => {
            // Truy·ªÅn th√™m boxId v√†o ƒë·ªÉ l√†m ch·ª©c nƒÉng "M·ªü Ti·∫øp"
            showResult(data, boxId);
        })
        .catch(() => Swal.fire({
            icon: 'error',
            title: 'Th·∫•t B·∫°i',
            text: 'S·ªë d∆∞ kh√¥ng ƒë·ªß ho·∫∑c l·ªói h·ªá th·ªëng!',
            background: '#111', color: '#fff'
        }));
    }

    function addToCart(boxId) {
        const userId = [[${nxvUser != null ? nxvUser.userId : 'null'}]];
        if (userId === 'null') { promptLogin(); return; }

        fetch(`/api/cart/add?userId=${userId}&boxId=${boxId}`, { method: 'POST' })
        .then(res => {
            if(res.ok) {
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 2000,
                    background: '#111', color: '#fff', iconColor: '#2ecc71'
                });
                Toast.fire({ icon: 'success', title: 'ƒê√£ th√™m v√†o gi·ªè!' });
            }
        });
    }

    // --- HI·ªÇN TH·ªä K·∫æT QU·∫¢ (KH√îNG RELOAD TRANG) ---
    function showResult(data, currentBoxId) {
        // 1. C·∫¨P NH·∫¨T S·ªê D∆Ø NGAY L·∫¨P T·ª®C (Real-time DOM update)
        if(data.currentBalance != null) {
            const formattedBalance = new Intl.NumberFormat('en-US').format(data.currentBalance);
            // C·∫≠p nh·∫≠t ·ªü header (ID: wallet-balance)
            const walletEl = document.getElementById('wallet-balance');
            if(walletEl) walletEl.innerText = formattedBalance;
        }

        // 2. X·ª≠ l√Ω m√†u s·∫Øc Rank
        let color = '#fff';
        if (data.rarity === 'S') color = '#ffd700';
        else if (data.rarity === 'A') color = '#ff4757';
        else if (data.rarity === 'B') color = '#9b59b6';
        else if (data.rarity === 'C') color = '#3498db';

        // 3. HTML cho ph·∫ßn B·∫£o Hi·ªÉm (Pity)
        let pityHtml = "";
        if (data.rarity !== 'S') {
            pityHtml = `<div style="margin-top: 15px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px dashed ${color};">
                            <i class="fas fa-shield-alt" style="color: #66fcf1;"></i>
                            <span style="color: #ccc; font-size: 13px;">B·∫£o hi·ªÉm S:</span>
                            <b style="color: #66fcf1; font-size: 16px;">${data.spinsUntilPity}</b>
                            <span style="color: #ccc; font-size: 13px;">l·∫ßn n·ªØa</span>
                        </div>`;
        } else {
            pityHtml = `<div style="margin-top: 15px; color: #ffd700; font-weight: bold; text-transform: uppercase; animation: pulse 1s infinite;">
                            <i class="fas fa-crown"></i> CH√öC M·ª™NG N·ªî H≈®!
                        </div>`;
        }

        // 4. Hi·ªán Popup K·∫øt Qu·∫£
        Swal.fire({
            title: `<span style="color:${color}; text-shadow: 0 0 15px ${color}">üéâ B·∫†N TR√öNG: ${data.rarity} üéâ</span>`,
            html: `
                <div class="animate__animated animate__zoomIn">
                    <img src="${data.itemImage}" style="width:150px; height:150px; object-fit:contain; margin:10px auto; border: 2px solid ${color}; border-radius: 15px; box-shadow: 0 0 20px ${color}; background: #1f2833;">
                    <h3 style="color: #fff; text-transform: uppercase; margin-bottom: 5px;">${data.itemName}</h3>
                    <div style="font-size: 13px; color: #aaa;">S·ªë d∆∞ c√≤n l·∫°i: <span style="color: #fff;">${new Intl.NumberFormat('en-US').format(data.currentBalance)}</span></div>
                    ${pityHtml}
                </div>
            `,
            background: 'rgba(15, 20, 25, 0.95)',
            showCancelButton: true,
            confirmButtonText: 'M·ªü Ti·∫øp! üé≤',
            cancelButtonText: 'ƒê√≥ng',
            confirmButtonColor: color, // N√∫t M·ªü ti·∫øp s·∫Ω c√πng m√†u v·ªõi Rank v·∫≠t ph·∫©m v·ª´a ra
            cancelButtonColor: '#333'
        }).then((result) => {
            // N·∫æU B·∫§M "M·ªû TI·∫æP" -> G·ªåI L·∫†I H√ÄM openBox (ƒê·ªá quy)
            if (result.isConfirmed) {
                openBox(currentBoxId);
            }
            // N·∫øu ƒë√≥ng -> Kh√¥ng l√†m g√¨ c·∫£ (Ti·ªÅn ƒë√£ update r·ªìi)
        });
    }

    function promptLogin() {
        Swal.fire({ title: 'Ch∆∞a ƒêƒÉng Nh·∫≠p!', icon: 'warning', confirmButtonText: 'ƒêƒÉng Nh·∫≠p', background: '#111', color: '#fff' })
        .then((res) => { if(res.isConfirmed) window.location.href='/login'; });
    }
</script>