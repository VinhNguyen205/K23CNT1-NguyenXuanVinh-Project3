<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>N·∫°p Xu | Mystery Box</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">

    <style>
        .deposit-card { max-width: 600px; margin: 50px auto; text-align: left; }

        /* Box hi·ªÉn th·ªã s·ªë d∆∞ */
        .balance-box {
            background: linear-gradient(90deg, rgba(31, 40, 51, 0.9), rgba(11, 12, 16, 0.9));
            border: 1px solid var(--neon-cyan);
            border-radius: 12px; padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; box-shadow: 0 0 15px rgba(102, 252, 241, 0.1);
        }

        .amount-select {
            background-color: #000 !important; color: #fff !important;
            border: 1px solid var(--neon-blue); padding: 15px;
            font-size: 1.1rem; font-weight: bold;
        }

        /* CARD PH∆Ø∆†NG TH·ª®C THANH TO√ÅN */
        .payment-method-item {
            position: relative; background: rgba(255, 255, 255, 0.05);
            border: 2px solid #333; border-radius: 12px; padding: 15px;
            cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; gap: 15px;
        }

        .payment-method-item:hover {
            border-color: var(--neon-blue);
            background: rgba(69, 162, 158, 0.1);
            transform: translateY(-2px);
        }

        .payment-method-item.active {
            border-color: var(--neon-green);
            background: rgba(46, 204, 113, 0.1);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.2);
        }

        .payment-method-item input[type="radio"] { display: none; }

        /* D·∫•u t√≠ch xanh */
        .check-icon { margin-left: auto; color: var(--neon-green); opacity: 0; transition: 0.3s; transform: scale(0.5); }
        .payment-method-item.active .check-icon { opacity: 1; transform: scale(1.2); }

        /* LOGO NG√ÇN H√ÄNG (C·∫•u h√¨nh k√≠ch th∆∞·ªõc chu·∫©n) */
        .method-logo {
            width: 45px; height: 45px;
            object-fit: contain;
            border-radius: 8px;
        }
        /* Logo n·ªÅn tr·∫Øng cho n·ªïi tr√™n n·ªÅn t·ªëi */
        .bg-white-logo {
            background-color: #fff;
            padding: 2px;
        }

        /* Modal & QR */
        .qr-container { text-align: center; background: #fff; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .qr-img { width: 100%; max-width: 250px; border-radius: 10px; border: 2px solid #000; }
        .transfer-info {
            background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;
            margin-top: 15px; border: 1px dashed var(--neon-cyan);
        }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
    </style>
</head>
<body>

<header>
    <div class="logo"><a href="/" style="text-decoration:none; color:#66fcf1;"><i class="fas fa-gift"></i> Mystery Box</a></div>
    <div class="menu">
        <a href="/" class="nav-link">üè† Trang Ch·ªß</a>
        <a href="/deposit" class="nav-link active deposit-btn">üíé N·∫°p Xu</a>
    </div>
    <div class="user-info" th:if="${nxvUser != null}">
        <div class="user-dropdown">
            <span class="fw-bold text-light me-2" th:text="${nxvUser.username}">User</span>
            <img th:src="'https://ui-avatars.com/api/?background=random&color=fff&name=' + ${nxvUser.fullName}" class="user-avatar">
            <div class="dropdown-menu-custom">
                <a href="/profile" class="dropdown-item-custom"><i class="fas fa-id-card"></i> H·ªì S∆°</a>
                <a href="/inventory" class="dropdown-item-custom"><i class="fas fa-box-open"></i> Kho ƒê·ªì</a>
                <a href="/logout" class="dropdown-item-custom" style="color: var(--neon-pink);"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</a>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <div class="glass-container deposit-card">
        <h2 class="text-center mb-4" style="color: var(--neon-green); text-transform: uppercase; text-shadow: 0 0 10px var(--neon-green);">
            <i class="fas fa-bolt"></i> Trung T√¢m N·∫°p Xu
        </h2>

        <div class="balance-box">
            <div>
                <small class="text-muted text-uppercase">S·ªë d∆∞ kh·∫£ d·ª•ng</small>
                <div class="fs-4 fw-bold text-white">
                    <span th:text="${#numbers.formatDecimal(nxvUser.walletBalance, 0, 'COMMA', 0, 'POINT')}">0</span> VNƒê
                </div>
            </div>
            <i class="fas fa-wallet fa-3x" style="color: var(--neon-cyan); opacity: 0.5;"></i>
        </div>

        <div th:if="${param.success}" class="alert alert-success bg-transparent border-success text-success text-center mb-3">
            <i class="fas fa-check-circle"></i> N·∫°p ti·ªÅn th√†nh c√¥ng! Ti·ªÅn ƒë√£ v√†o v√≠.
        </div>

        <form action="/api/deposit/process" method="post" id="depositForm">

            <div class="mb-4">
                <label class="form-label text-light fw-bold mb-2">Ch·ªçn M·ªánh Gi√°:</label>
                <select name="amount" id="amountSelect" class="form-select amount-select rounded-3">
                    <option value="20000">20.000 VNƒê</option>
                    <option value="50000">50.000 VNƒê</option>
                    <option value="100000" selected>100.000 VNƒê (Ph·ªï bi·∫øn)</option>
                    <option value="200000">200.000 VNƒê</option>
                    <option value="500000">500.000 VNƒê</option>
                    <option value="1000000">1.000.000 VNƒê</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="form-label text-light fw-bold mb-3">Ph∆∞∆°ng Th·ª©c Thanh To√°n:</label>

                <div class="d-flex flex-column gap-3">

                    <label class="payment-method-item active" onclick="selectMethod(this, 'momo')">
                        <img src="https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png" class="method-logo" alt="MoMo">
                        <div>
                            <div class="fw-bold text-white">V√≠ ƒêi·ªán T·ª≠ MoMo</div>
                            <small class="text-muted" style="font-size: 12px;">Qu√©t m√£ QR si√™u t·ªëc</small>
                        </div>
                        <input type="radio" name="method" value="Momo" checked>
                        <i class="fas fa-check-circle check-icon fa-lg"></i>
                    </label>

                    <label class="payment-method-item" onclick="selectMethod(this, 'bank')">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/2/25/Logo_MB_new.png" class="method-logo bg-white-logo" alt="MB Bank">
                        <div>
                            <div class="fw-bold text-white">Chuy·ªÉn Kho·∫£n Ng√¢n H√†ng</div>
                            <small class="text-muted" style="font-size: 12px;">MB Bank / VietQR 24/7</small>
                        </div>
                        <input type="radio" name="method" value="Bank">
                        <i class="fas fa-check-circle check-icon fa-lg"></i>
                    </label>

                    <label class="payment-method-item" onclick="selectMethod(this, 'visa')">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" class="method-logo bg-white-logo" alt="Visa">
                        <div>
                            <div class="fw-bold text-white">Th·∫ª Qu·ªëc T·∫ø</div>
                            <small class="text-muted" style="font-size: 12px;">Visa, MasterCard, JCB</small>
                        </div>
                        <input type="radio" name="method" value="VISA">
                        <i class="fas fa-check-circle check-icon fa-lg"></i>
                    </label>

                </div>
            </div>

            <button type="button" onclick="openPaymentModal()" class="btn btn-success w-100 py-3 rounded-pill fw-bold fs-5"
                    style="background: var(--neon-green); border: none; color: #000; box-shadow: 0 0 20px rgba(46, 204, 113, 0.4);">
                <i class="fas fa-qrcode me-2"></i> T·∫†O M√É THANH TO√ÅN
            </button>
        </form>
    </div>
</div>

<div class="modal fade" id="paymentModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #1f2833; border: 1px solid var(--neon-cyan); color: #fff;">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-info"><i class="fas fa-qrcode me-2"></i> Th√¥ng Tin Chuy·ªÉn Kho·∫£n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="qr-container">
                    <img id="qrImage" src="" class="qr-img" alt="QR Code">
                    <p class="text-dark mt-2 mb-0 fw-bold small">M·ªü App Ng√¢n h√†ng/MoMo ƒë·ªÉ qu√©t</p>
                </div>

                <div class="transfer-info">
                    <div class="info-row">
                        <span class="text-muted">Ng√¢n h√†ng:</span>
                        <span class="fw-bold text-white">MB BANK (Qu√¢n ƒê·ªôi)</span>
                    </div>
                    <div class="info-row">
                        <span class="text-muted">S·ªë t√†i kho·∫£n:</span>
                        <span class="fw-bold text-white">0352526830</span>
                    </div>
                    <div class="info-row">
                        <span class="text-muted">Ch·ªß t√†i kho·∫£n:</span>
                        <span class="fw-bold text-white text-uppercase">NGUYEN XUAN VINH</span>
                    </div>
                    <div class="info-row">
                        <span class="text-muted">S·ªë ti·ªÅn:</span>
                        <span class="fw-bold text-warning" id="displayAmount">0 ƒë</span>
                    </div>
                    <div class="info-row">
                        <span class="text-muted">N·ªôi dung CK:</span>
                        <span class="fw-bold text-info" id="displayContent">NXV...</span>
                    </div>
                </div>

                <div class="alert alert-warning mt-3 mb-0" style="font-size: 12px; background: rgba(241, 196, 15, 0.1); border-color: #f1c40f; color: #f1c40f;">
                    <i class="fas fa-exclamation-triangle"></i> <b>L∆∞u √Ω:</b> Vui l√≤ng nh·∫≠p ch√≠nh x√°c <b>N·ªôi dung chuy·ªÉn kho·∫£n</b> ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông c·ªông ti·ªÅn.
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê·ªÉ sau</button>
                <button type="button" onclick="submitRealForm()" class="btn btn-success fw-bold">
                    <i class="fas fa-check-circle me-2"></i> T√¥i ƒë√£ chuy·ªÉn ti·ªÅn
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let selectedType = 'momo';

    function selectMethod(element, type) {
        document.querySelectorAll('.payment-method-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        element.querySelector('input[type="radio"]').checked = true;
        selectedType = type;
    }

    function openPaymentModal() {
        const amount = document.getElementById('amountSelect').value;
        const formattedAmount = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        const randomCode = 'NXV' + Math.floor(Math.random() * 1000000);

        document.getElementById('displayAmount').innerText = formattedAmount;
        document.getElementById('displayContent').innerText = randomCode;

        // T·∫†O QR CODE ƒê·ªòNG (VietQR API - MB Bank)
        // Thay s·ªë t√†i kho·∫£n c·ªßa b·∫°n v√†o ƒë√¢y n·∫øu mu·ªën ƒë·ªïi
        const bankId = 'MB';
        const accountNo = '0352526830';
        const accountName = 'NGUYEN XUAN VINH';

        let qrUrl = `https://img.vietqr.io/image/${bankId}-${accountNo}-compact.jpg?amount=${amount}&addInfo=${randomCode}&accountName=${accountName}`;

        document.getElementById('qrImage').src = qrUrl;

        const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
        modal.show();
    }

    function submitRealForm() {
        // ·∫®n modal
        bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();

        Swal.fire({
            title: 'ƒêang ki·ªÉm tra giao d·ªãch...',
            html: 'Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t.',
            timer: 2500,
            timerProgressBar: true,
            background: '#111', color: '#fff',
            didOpen: () => { Swal.showLoading() }
        }).then(() => {
            // Submit form th·∫≠t
            document.getElementById('depositForm').submit();
        });
    }

    // Check URL success
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('success')) {
        Swal.fire({
            icon: 'success', title: 'Th√†nh C√¥ng!', text: 'S·ªë d∆∞ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
            background: '#111', color: '#fff', confirmButtonColor: '#2ecc71'
        }).then(() => { window.history.replaceState({}, document.title, "/deposit"); });
    }
</script>

</body>
</html>