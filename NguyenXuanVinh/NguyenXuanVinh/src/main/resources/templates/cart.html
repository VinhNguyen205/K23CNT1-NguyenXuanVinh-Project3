<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gi·ªè H√†ng</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
<header>
    <div class="logo"><a href="/" style="text-decoration:none; color:#e94560;">üéÅ Mystery Box</a></div>
    <div class="menu">
        <a href="/" class="nav-link">üè† Trang Ch·ªß</a>
        <a href="/inventory" class="nav-link">üéí Kho ƒê·ªì</a>
        <a href="/cart" class="nav-link active">üõí Gi·ªè H√†ng</a>
        <a href="/admin" class="nav-link admin-btn" th:if="${user != null and user.isAdmin}">üõ†Ô∏è Qu·∫£n Tr·ªã</a>
    </div>
    <div class="user-info" th:if="${user != null}">
        <span><b th:text="${user.fullName}">User</b></span>
    </div>
</header>

<div class="container">
    <h1 class="title">üõí GI·ªé H√ÄNG C·ª¶A B·∫†N</h1>

    <div th:if="${cartItems == null || cartItems.isEmpty()}" style="text-align: center; color: #ccc;">
        <h3>Gi·ªè h√†ng tr·ªëng!</h3>
        <a href="/" class="btn-buy" style="display:inline-block; width:200px; margin-top:20px;">ƒêi mua s·∫Øm</a>
    </div>

    <div th:if="${cartItems != null && !cartItems.isEmpty()}">
        <table style="width: 100%; border-collapse: collapse; color: #fff; margin-bottom: 20px;">
            <thead>
            <tr style="background: #0f3460; text-align: left;">
                <th style="padding: 15px;">S·∫£n ph·∫©m</th>
                <th>Gi√°</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>Th√†nh ti·ªÅn</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item : ${cartItems}" style="border-bottom: 1px solid #0f3460;">
                <td style="padding: 15px; display: flex; align-items: center; gap: 15px;">
                    <img th:src="${item.blindBox.imageUrl}" width="50" style="border-radius: 5px;">
                    <span th:text="${item.blindBox.boxName}">T√™n H·ªôp</span>
                </td>
                <td th:text="${#numbers.formatDecimal(item.blindBox.price, 0, 'COMMA', 0, 'POINT')} + ' ƒë'"></td>
                <td th:text="${item.quantity}">1</td>
                <td style="color: #ffd700; font-weight: bold;"
                    th:text="${#numbers.formatDecimal(item.blindBox.price * item.quantity, 0, 'COMMA', 0, 'POINT')} + ' ƒë'"></td>
                <td>
                    <button class="btn-sell" style="background: #e74c3c; width: auto; padding: 5px 10px;"
                            th:onclick="'removeItem(' + ${item.cartItemId} + ')'">X√≥a</button>
                </td>
            </tr>
            </tbody>
        </table>

        <div style="text-align: right; margin-top: 30px;">
            <h2 style="color: #ffd700;">T·ªïng c·ªông: <span th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')}">0</span> ƒë</h2>
            <button class="btn-buy" style="width: 250px; margin-top: 20px;" onclick="checkout()">üí≥ THANH TO√ÅN NGAY</button>        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function removeItem(itemId) {
        fetch('/api/cart/remove/' + itemId, { method: 'DELETE' })
        .then(res => {
            if(res.ok) location.reload();
            else alert("L·ªói!");
        });
    }
    // H√†m x·ª≠ l√Ω thanh to√°n
    async function checkout() {
        const userId = [[${user != null ? user.userId : 'null'}]];

        // Ki·ªÉm tra gi·ªè h√†ng c√≥ tr·ªëng kh√¥ng (D·ª±a v√†o UI)
        // N·∫øu kh√¥ng c√≥ d√≤ng tr n√†o trong tbody th√¨ l√† tr·ªëng
        if (document.querySelectorAll('tbody tr').length === 0) {
            Swal.fire('Gi·ªè h√†ng tr·ªëng', 'Vui l√≤ng mua th√™m ƒë·ªì!', 'warning');
            return;
        }

        // Hi·ªán Form nh·∫≠p th√¥ng tin giao h√†ng
        const { value: formValues } = await Swal.fire({
            title: 'Th√¥ng tin giao h√†ng',
            html:
                '<input id="swal-name" class="swal2-input" placeholder="H·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n">' +
                '<input id="swal-phone" class="swal2-input" placeholder="S·ªë ƒëi·ªán tho·∫°i">' +
                '<input id="swal-address" class="swal2-input" placeholder="ƒê·ªãa ch·ªâ giao h√†ng">',
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'X√°c nh·∫≠n ƒë·∫∑t h√†ng',
            preConfirm: () => {
                return {
                    name: document.getElementById('swal-name').value,
                    phone: document.getElementById('swal-phone').value,
                    address: document.getElementById('swal-address').value
                }
            }
        });

        if (formValues) {
            // Ki·ªÉm tra d·ªØ li·ªáu nh·∫≠p
            if(!formValues.name || !formValues.phone || !formValues.address) {
                Swal.fire('L·ªói', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            // G·ªçi API ƒê·∫∑t h√†ng
            Swal.fire({ title: 'ƒêang x·ª≠ l√Ω...', didOpen: () => Swal.showLoading() });


           fetch(`/api/order/checkout?userId=${userId}&name=${encodeURIComponent(formValues.name)}&phone=${encodeURIComponent(formValues.phone)}&address=${encodeURIComponent(formValues.address)}`, {
           method: 'POST'
})
            .then(res => {
                if(res.ok) {
                    Swal.fire('Th√†nh c√¥ng!', 'ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t·∫°o.', 'success')
                    .then(() => {
                        window.location.href = '/inventory'; // Chuy·ªÉn h∆∞·ªõng v·ªÅ kho ƒë·ªì ho·∫∑c trang ch·ªß
                    });
                } else {
                    res.text().then(text => Swal.fire('L·ªói', text, 'error'));
                }
            })
            .catch(err => Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi server', 'error'));
        }
    }
</script>
</body>
</html>