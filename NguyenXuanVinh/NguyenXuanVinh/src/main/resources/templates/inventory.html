<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Kho Äá»“ Cá»§a TÃ´i</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<header>
    <div class="logo">
        <a href="/" style="text-decoration:none; color:#66fcf1;">
            <i class="fas fa-gift"></i> Mystery Box
        </a>
    </div>

    <div class="menu">
        <a href="/" class="nav-link">ğŸ  Trang Chá»§</a>
        <a href="/cart" class="nav-link" th:classappend="${currentPage == 'cart'} ? 'active'">ğŸ›ï¸ Giá» HÃ ng</a>
        <a href="/inventory" class="nav-link" th:classappend="${currentPage == 'inventory'} ? 'active'">ğŸ’ Kho Äá»“</a>
        <a href="/deposit" class="nav-link deposit-btn">ğŸ’ Náº¡p Xu</a>

        <a href="/admin" class="nav-link admin-btn" th:if="${nxvUser != null and nxvUser.isAdmin}">ğŸ› ï¸ Quáº£n Trá»‹</a>
    </div>

    <div class="user-info" th:if="${nxvUser != null}">
        <div class="wallet me-3">
            ğŸ’° <span id="wallet-balance" th:text="${#numbers.formatDecimal(nxvUser.walletBalance, 0, 'COMMA', 0, 'POINT')}">0</span>
        </div>

        <div class="user-dropdown">
            <span class="fw-bold text-light me-2" th:text="${nxvUser.username}">User</span>
            <img th:src="'https://ui-avatars.com/api/?background=random&color=fff&name=' + ${nxvUser.fullName}" class="user-avatar">

            <div class="dropdown-menu-custom">
                <div style="padding: 10px 20px; border-bottom: 1px solid #333; color: #aaa; font-size: 12px;">
                    Xin chÃ o, <b style="color: #fff;" th:text="${nxvUser.fullName}">Name</b>
                </div>
                <a href="/profile" class="dropdown-item-custom"><i class="fas fa-id-card"></i> Há»“ SÆ¡ CÃ¡ NhÃ¢n</a>
                <a href="/shipment/history" class="dropdown-item-custom"><i class="fas fa-history"></i> Lá»‹ch Sá»­ Giao HÃ ng</a>
                <a href="/logout" class="dropdown-item-custom" style="color: #ff4757;"><i class="fas fa-sign-out-alt"></i> ÄÄƒng Xuáº¥t</a>
            </div>
        </div>
    </div>

    <div class="user-info" th:if="${nxvUser == null}">
        <a href="/login" class="btn-buy" style="padding: 8px 20px; text-decoration: none; width: auto; margin: 0;">ÄÄƒng Nháº­p</a>
    </div>
</header>

<div class="container mt-5">

    <div class="inventory-header">
        <h2 class="inventory-title"><i class="fas fa-box-open"></i> Kho Äá»“ Cá»§a TÃ´i</h2>

        <div class="btn-action-group">
            <a href="/shipment/history" class="btn-history">
                <i class="fas fa-history"></i> Lá»‹ch Sá»­ Giao HÃ ng
            </a>

            <a href="/shipment/create" class="btn-ship-request" th:if="${!inventoryList.isEmpty()}">
                <i class="fas fa-truck-fast"></i> YÃªu Cáº§u Giao HÃ ng
            </a>
        </div>
    </div>

    <div th:if="${inventoryList.isEmpty()}" style="text-align: center; color: #888; margin-top: 80px;">
        <i class="fas fa-ghost fa-4x mb-3" style="color: #333;"></i>
        <h3>Kho trá»‘ng trÆ¡n!</h3>
        <p>HÃ£y ra trang chá»§ má»Ÿ há»™p Ä‘á»ƒ kiáº¿m Ä‘á»“ nhÃ©.</p>
        <a href="/" class="btn-buy" style="display:inline-block; width:auto; padding: 10px 30px; margin-top:20px;">Äi SÄƒn Ngay</a>
    </div>

    <div class="box-grid">
        <div class="box-card" th:each="item : ${inventoryList}" th:id="'card-' + ${item.inventoryId}">
            <div class="rank-badge"
                 th:classappend="'rank-' + ${item.boxItem.rarityLevel}"
                 th:text="'Rank ' + ${item.boxItem.rarityLevel}"></div>

            <div class="box-image">
                <img th:src="${item.boxItem.imageUrl}" alt="Item">
            </div>

            <div class="box-info">
                <h3 th:text="${item.boxItem.itemName}">TÃªn Váº­t Pháº©m</h3>

                <p style="font-size:13px; color:#888; margin-bottom: 5px;">GiÃ¡ trá»‹ thá»±c:</p>
                <div style="font-size: 16px; font-weight: bold; color: #fff; margin-bottom: 15px;">
                    <span th:text="${#numbers.formatDecimal(item.boxItem.marketValue, 0, 'COMMA', 0, 'POINT')}">0</span> Ä‘
                </div>

                <button class="btn-sell" th:onclick="'sellItem(' + ${item.inventoryId} + ')'">
                    <i class="fas fa-hand-holding-dollar"></i> BÃ¡n Láº¡i (90%)
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:inline="javascript">
    function sellItem(inventoryId) {
        const userId = [[${nxvUser.userId}]];
        Swal.fire({
            title: 'BÃ¡n váº­t pháº©m nÃ y?',
            text: "Báº¡n sáº½ nháº­n láº¡i 90% giÃ¡ trá»‹ vÃ o vÃ­.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#2ecc71',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Äá»“ng Ã½ bÃ¡n',
            cancelButtonText: 'Giá»¯ láº¡i',
            background: '#1f2833', color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/blindbox/sell?userId=${userId}&inventoryId=${inventoryId}`, { method: 'POST' })
                .then(r => { if(!r.ok) throw new Error(); return r.json(); })
                .then(d => {
                    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, background: '#1f2833', color: '#fff', iconColor: '#2ecc71' });
                    Toast.fire({ icon: 'success', title: d.message });
                    document.getElementById('card-' + inventoryId).remove();
                    document.getElementById('wallet-balance').innerText = new Intl.NumberFormat('vi-VN').format(d.newBalance);
                    if(document.querySelectorAll('.box-card').length === 0) location.reload();
                })
                .catch(() => Swal.fire({ title: 'Lá»—i!', text: 'KhÃ´ng thá»ƒ bÃ¡n.', icon: 'error', background: '#1f2833', color: '#fff' }));
            }
        })
    }
</script>
</body>
</html>