<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Kho Äá»“ Cá»§a TÃ´i</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<header>
    <div class="logo"><a href="/" style="text-decoration:none; color:#e94560;">ğŸ Mystery Box</a></div>
    <div class="menu">
        <a href="/" class="nav-link">ğŸ  Trang Chá»§</a>
        <a href="/inventory" class="nav-link active">ğŸ’ Kho Äá»“</a>
        <a href="/admin" class="nav-link admin-btn" th:if="${user != null and user.isAdmin}">ğŸ› ï¸ Quáº£n Trá»‹</a>
    </div>
    <div class="user-info" th:if="${user != null}">
        <span>Xin chÃ o, <b th:text="${user.fullName}">User</b></span>
        <div class="wallet">
            ğŸ’° <span id="wallet-balance" th:text="${#numbers.formatDecimal(user.walletBalance, 0, 'COMMA', 0, 'POINT')}">0</span> VNÄ
        </div>
    </div>
</header>

<div class="container">
    <h1 class="title">ğŸ’ Tá»¦ Äá»’ Cá»¦A TÃ”I</h1>

    <div th:if="${inventoryList.isEmpty()}" style="text-align: center; color: #ccc;">
        <h3>Kho trá»‘ng trÆ¡n! ğŸ•¸ï¸</h3>
        <p>HÃ£y ra trang chá»§ má»Ÿ há»™p Ä‘á»ƒ kiáº¿m Ä‘á»“ nhÃ©.</p>
        <a href="/" class="btn-buy" style="display:inline-block; width:200px; margin-top:20px;">Vá» trang chá»§</a>
    </div>

    <div class="box-grid">
        <div class="box-card" th:each="item : ${inventoryList}" th:id="'card-' + ${item.inventoryId}">
            <div class="rank-badge" th:text="${item.boxItem.rarityLevel}"
                 th:classappend="'rank-' + ${item.boxItem.rarityLevel}"></div>

            <div class="box-image">
                <img th:src="${item.boxItem.imageUrl}" alt="Item Image">
            </div>
            <div class="box-info">
                <h3 th:text="${item.boxItem.itemName}">TÃªn MÃ³n</h3>

                <p style="font-size:14px; color:#aaa;">GiÃ¡ trá»‹:
                    <span th:text="${#numbers.formatDecimal(item.boxItem.marketValue, 0, 'COMMA', 0, 'POINT')}">0</span> Ä‘
                </p>

                <button class="btn-sell" th:onclick="'sellItem(' + ${item.inventoryId} + ')'">
                    ğŸ’¸ BÃ¡n láº¡i (Nháº­n 90%)
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function sellItem(inventoryId) {
        const userId = [[${user.userId}]];

        Swal.fire({
            title: 'Báº¡n cháº¯c cháº¯n muá»‘n bÃ¡n?',
            text: "MÃ³n nÃ y sáº½ bá»‹ xÃ³a khá»i kho vÃ  tiá»n sáº½ vá» vÃ­!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'BÃ¡n luÃ´n!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Gá»i API BÃ¡n hÃ ng
                fetch(`/api/blindbox/sell?userId=${userId}&inventoryId=${inventoryId}`, {
                    method: 'POST'
                })
                .then(response => {
                    if (!response.ok) throw new Error("Lá»—i bÃ¡n hÃ ng!");
                    return response.json();
                })
                .then(data => {
                    // 1. ThÃ´ng bÃ¡o thÃ nh cÃ´ng
                    Swal.fire('ÄÃ£ bÃ¡n!', data.message, 'success');

                    // 2. XÃ³a cÃ¡i tháº» sáº£n pháº©m Ä‘Ã³ khá»i mÃ n hÃ¬nh (Hiá»‡u á»©ng UI)
                    document.getElementById('card-' + inventoryId).remove();

                    // 3. Cáº­p nháº­t sá»‘ dÆ° trÃªn header
                    document.getElementById('wallet-balance').innerText = new Intl.NumberFormat().format(data.newBalance);
                })
                .catch(error => {
                    Swal.fire('Lá»—i!', 'KhÃ´ng thá»ƒ bÃ¡n mÃ³n nÃ y.', 'error');
                });
            }
        })
    }
</script>

</body>
</html>